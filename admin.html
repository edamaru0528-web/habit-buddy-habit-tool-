<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#0d9488">
    <title>ç®¡ç†è€…ç”»é¢ - ç¿’æ…£åŒ–ãƒˆãƒ©ãƒƒã‚«ãƒ¼ Ver 9.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
    <style>
        :root {
            --primary: #b9f0fa;
            --duo-blue: #1cb0f6;
            --duo-blue-dark: #1899d6;
            --duo-green: #58cc02;
            --duo-green-dark: #46a302;
            --duo-gray: #e5e5e5;
            --duo-gray-dark: #afafaf;
            --bg: #f7f7f7;
            --bg-card: #ffffff;
            --text: #4b4b4b;
            --text-muted: #777777;
            --border: #e5e5e5;
            --danger: #ff4b4b;
            --success: #58cc02;
            --warning: #ff9600;
        }

        :root.dark {
            --bg: #131f24;
            --bg-card: #131f24;
            --text: #eeeeee;
            --border: #3c444d;
            --duo-gray: #3c444d;
            --duo-gray-dark: #202b33;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            line-height: 1.5;
        }

        .container {
            max-width: 600px;
            /* æ¨ªé•·ã™ããŸã®ã‚’ä¿®æ­£ */
            margin: 0 auto;
            padding: 24px;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
            border-bottom: 2px solid var(--border);
            padding-bottom: 16px;
        }

        header h1 {
            font-size: 1.75rem;
            font-weight: 800;
            color: var(--duo-blue);
        }

        .btn-3d {
            position: relative;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 700;
            border: none;
            cursor: pointer;
            transition: all 0.1s;
        }

        .btn-3d:active {
            transform: translateY(4px);
        }

        .btn-3d::after {
            content: '';
            position: absolute;
            bottom: -4px;
            left: 0;
            right: 0;
            height: 100%;
            border-radius: 16px;
            z-index: -1;
        }

        .btn-3d:active::after {
            bottom: 0;
        }

        .btn-primary {
            background: var(--duo-blue);
            color: white;
        }

        .btn-primary::after {
            background: var(--duo-blue-dark);
        }

        .section {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 0 4px 0 var(--border);
        }

        .section h2 {
            font-size: 1.25rem;
            font-weight: 800;
            margin-bottom: 20px;
        }

        .add-form {
            display: flex;
            gap: 12px;
        }

        .add-form input {
            flex: 1;
            padding: 14px;
            border: 2px solid var(--border);
            border-radius: 16px;
            font-size: 1rem;
            font-family: inherit;
            background: var(--bg-card);
            box-shadow: 0 4px 0 var(--border);
        }

        .user-card {
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 20px;
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr auto auto;
            gap: 20px;
            align-items: center;
            margin-bottom: 16px;
            box-shadow: 0 4px 0 var(--border);
            position: relative;
            cursor: pointer;
            transition: transform 0.1s;
        }

        .user-card:active {
            transform: scale(0.98);
        }

        .user-name {
            font-size: 1.1rem;
            font-weight: 800;
        }

        .user-url {
            font-size: 0.8rem;
            color: var(--text-muted);
            word-break: break-all;
            margin-top: 4px;
        }

        .user-url a {
            color: var(--duo-blue);
            text-decoration: none;
            border-bottom: 1px dotted var(--duo-blue);
        }

        .user-stats-container {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .user-stat-row {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .user-stat-row b {
            color: var(--text);
            font-size: 0.9rem;
        }

        .menu-container {
            position: relative;
            z-index: 10;
        }

        .menu-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 8px;
            color: var(--text-muted);
            line-height: 1;
        }

        .dropdown-menu {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            z-index: 100;
            display: none;
            min-width: 160px;
        }

        .dropdown-menu.show {
            display: block;
        }

        .dropdown-item {
            padding: 12px 16px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .dropdown-item:last-child {
            border-bottom: none;
        }

        .dropdown-item:hover {
            background: var(--bg);
        }

        .dropdown-item.delete {
            color: var(--danger);
        }

        .action-btn {
            background: var(--duo-gray);
            border: none;
            border-radius: 12px;
            padding: 8px 12px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 3px 0 var(--duo-gray-dark);
            transition: all 0.1s;
            font-size: 0.8rem;
        }

        .action-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .action-btn.delete {
            background: var(--danger);
            color: white;
            box-shadow: 0 3px 0 #cc3c3c;
        }

        .action-btn.sync {
            background: var(--duo-green);
            color: white;
            border-color: var(--duo-green-dark);
            box-shadow: 0 3px 0 var(--duo-green-dark);
            width: auto;
            flex: none;
        }

        @media (max-width: 600px) {
            .container {
                padding: 12px;
            }

            .user-card {
                grid-template-columns: 1fr auto;
            }

            .user-stats-container {
                grid-area: 2 / 1 / 3 / 2;
            }

            .user-stats {
                grid-area: 1 / 2 / 3 / 3;
            }

            .menu-container {
                position: absolute;
                top: 12px;
                right: 8px;
            }
        }

        /* QRãƒ¢ãƒ¼ãƒ€ãƒ« */
        #qrModal img {
            max-width: 200px;
            margin: 20px auto;
            display: block;
        }

        .progress-ring {
            width: 64px;
            height: 64px;
            position: relative;
        }

        .progress-ring svg {
            transform: rotate(-90deg);
        }

        .progress-ring circle {
            fill: none;
            stroke-width: 8;
            stroke-linecap: round;
        }

        .progress-ring .bg {
            stroke: var(--border);
        }

        .progress-ring .fg {
            stroke: var(--duo-green);
            transition: stroke-dashoffset 0.5s;
        }

        .progress-ring .pct {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.9rem;
            font-weight: 800;
            color: var(--duo-green);
        }

        .action-btn {
            background: var(--duo-gray);
            border: none;
            border-radius: 12px;
            padding: 8px 12px;
            font-weight: 700;
            cursor: pointer;
            box-shadow: 0 3px 0 var(--duo-gray-dark);
            transition: all 0.1s;
        }

        .action-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .action-btn.delete {
            background: var(--danger);
            color: white;
            box-shadow: 0 3px 0 #cc3c3c;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: 0.3s;
        }

        .modal-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            background: var(--bg-card);
            border-radius: 20px;
            padding: 24px;
            width: 90%;
            max-width: 500px;
            border: 2px solid var(--border);
            box-shadow: 0 8px 0 var(--border);
        }

        .habit-edit-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
            padding: 12px;
            background: var(--bg);
            border: 2px solid var(--border);
            border-radius: 16px;
        }

        .habit-edit-item input {
            flex: 1;
            padding: 8px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-family: inherit;
            font-weight: 600;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%) translateY(100px);
            background: var(--duo-blue);
            color: white;
            padding: 12px 24px;
            border-radius: 16px;
            font-weight: 700;
            opacity: 0;
            transition: 0.3s;
            z-index: 2000;
            box-shadow: 0 4px 0 var(--duo-blue-dark);
        }

        .toast.show {
            transform: translateX(-50%) translateY(0);
            opacity: 1;
        }

        .hidden {
            display: none;
        }

        .modal-input,
        .modal-select {
            padding: 10px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 0.9rem;
            background: var(--bg-card);
            color: var(--text);
            font-family: inherit;
        }

        .modal-buttons {
            display: flex;
            gap: 8px;
            justify-content: flex-end;
            margin-top: 20px;
        }

        .modal-btn {
            padding: 10px 20px;
            border-radius: 12px;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            border: none;
            box-shadow: 0 3px 0 var(--border);
            transition: all 0.1s;
        }

        .modal-btn:active {
            transform: translateY(2px);
            box-shadow: none;
        }

        .modal-btn.cancel {
            background: var(--duo-gray);
            color: var(--text);
            box-shadow: 0 3px 0 var(--duo-gray-dark);
        }

        .modal-btn.confirm {
            background: var(--duo-green);
            color: white;
            box-shadow: 0 3px 0 var(--duo-green-dark);
        }

        .modal-btn.danger {
            background: var(--danger);
            color: white;
            box-shadow: 0 3px 0 #cc3c3c;
        }

        /* æœŸé–“é¸æŠãƒœã‚¿ãƒ³ */
        .period-btn {
            padding: 8px 16px;
            border: 2px solid var(--border);
            border-radius: 12px;
            background: var(--bg-card);
            color: var(--text);
            font-size: 0.8rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
        }

        .period-btn:hover {
            background: var(--duo-blue);
            color: white;
            border-color: var(--duo-blue);
        }

        .period-btn.active {
            background: var(--duo-blue);
            color: white;
            border-color: var(--duo-blue-dark);
            box-shadow: 0 2px 0 var(--duo-blue-dark);
        }

        /* ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé€²æ—è¡¨ç¤º */
        .report-progress {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .progress-step.pending {
            color: var(--text-muted);
        }

        .progress-step.active {
            color: var(--duo-blue);
            font-weight: 700;
        }

        .progress-step.done {
            color: var(--success);
        }

        .progress-step.skipped {
            color: #F59E0B;
            /* ã‚ªãƒ¬ãƒ³ã‚¸ï¼ˆè­¦å‘Šè‰²ï¼‰ */
        }

        .progress-step.error {
            color: var(--danger);
        }

        /* ãƒ¬ãƒãƒ¼ãƒˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .chart-preview-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }

        .chart-preview-container.show {
            display: flex;
        }

        .chart-preview-box {
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 500px;
            width: 90%;
        }

        /* ãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« */
        .report-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            padding: 20px;
        }

        .report-modal-overlay.show {
            display: flex;
        }

        .report-modal {
            background: var(--bg-card);
            border-radius: 16px;
            max-width: 700px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .report-modal-header {
            padding: 16px 20px;
            border-bottom: 2px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .report-modal-header h3 {
            margin: 0;
            font-size: 1.1rem;
        }

        .report-modal-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .report-text-content {
            background: var(--bg);
            border-radius: 12px;
            padding: 16px;
            font-family: monospace;
            font-size: 0.85rem;
            white-space: pre-wrap;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
        }

        .report-modal-footer {
            padding: 16px 20px;
            border-top: 2px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        /* æŠ˜ã‚ŠãŸãŸã¿ã‚»ã‚¯ã‚·ãƒ§ãƒ³ */
        details summary {
            list-style: none;
        }

        details summary::-webkit-details-marker {
            display: none;
        }

        details[open]>summary .toggle-arrow {
            transform: rotate(90deg);
        }

        .toggle-arrow {
            display: inline-block;
            transition: transform 0.2s ease;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>ğŸ‘¨â€ğŸ’¼ ç®¡ç†ç”»é¢</h1>
            <p>ãƒ‡ãƒ¼ã‚¿ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ç›£è¦– (Ver 9.0)</p>
        </header>

        <div class="section">
            <h2>â• ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ </h2>
            <form class="add-form" id="addForm" style="flex-direction:column; gap:12px;">
                <input type="text" id="userInput" placeholder="å­¦ç¿’è€…å..." autocomplete="off" style="width:100%;">
                <div style="display:flex; gap:8px; flex-wrap:wrap;">
                    <div style="flex:1; min-width:140px;">
                        <label style="font-size:0.75rem; color:var(--text-muted); display:block; margin-bottom:4px;">ğŸ“…
                            é–‹å§‹æ—¥</label>
                        <input type="date" id="userStartDate" class="modal-input" style="width:100%;">
                    </div>
                    <div style="flex:1; min-width:140px;">
                        <label style="font-size:0.75rem; color:var(--text-muted); display:block; margin-bottom:4px;">ğŸ“‹
                            å—è¬›ãƒ—ãƒ©ãƒ³</label>
                        <select id="userPlan" class="modal-select" style="width:100%; padding:10px;">
                            <option value="3months">3ãƒ¶æœˆã‚³ãƒ¼ã‚¹</option>
                            <option value="6months">6ãƒ¶æœˆã‚³ãƒ¼ã‚¹</option>
                            <option value="9months">9ãƒ¶æœˆã‚³ãƒ¼ã‚¹</option>
                        </select>
                    </div>
                </div>
                <button type="submit" class="btn-3d btn-primary" style="width:100%;">ä½œæˆ</button>
            </form>
        </div>

        <div class="section">
            <h2>ğŸ‘¥ ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ï¼ˆãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ï¼‰</h2>
            <div class="user-list" id="userList"></div>
        </div>

        <div class="section">
            <details>
                <summary
                    style="cursor:pointer; font-weight:700; font-size:1.1rem; padding:8px 0; display:flex; align-items:center; gap:8px;">
                    <span class="toggle-arrow">â–¶</span> âš™ï¸ å„ç¨®è¨­å®šï¼†ãƒ¬ãƒãƒ¼ãƒˆä½œæˆ
                </summary>
                <div style="margin-top:16px;">
                    <!-- å…¬é–‹URLè¨­å®š -->
                    <details style="margin-bottom:16px;">
                        <summary
                            style="cursor:pointer; font-weight:700; font-size:0.95rem; padding:12px; background:var(--bg); border-radius:12px; display:flex; align-items:center; gap:8px;">
                            ğŸŒ å…¬é–‹URLè¨­å®š
                        </summary>
                        <div
                            style="padding:16px; background:var(--card-bg); border-radius:0 0 12px 12px; margin-top:-4px; border:1px solid var(--border); border-top:none;">
                            <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:12px;">
                                ã‚¹ãƒãƒ›ã¨å…±æœ‰ã™ã‚‹ãŸã‚ã«ã€å…¬é–‹ã—ãŸWebã‚µã‚¤ãƒˆã®URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚<br>(ä¾‹: https://username.github.io/habit-tracker/)
                            </p>
                            <div style="display:flex; gap:8px;">
                                <input type="text" id="baseUrlInput" placeholder="https://..." class="modal-input"
                                    style="flex:1;">
                                <button class="btn-3d btn-primary" onclick="saveBaseUrl()"
                                    style="font-size:0.9rem; padding:10px 16px;">è¨­å®šä¿å­˜</button>
                            </div>
                        </div>
                    </details>

                    <!-- ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ -->
                    <details style="margin-bottom:16px;">
                        <summary
                            style="cursor:pointer; font-weight:700; font-size:0.95rem; padding:12px; background:var(--bg); border-radius:12px; display:flex; align-items:center; gap:8px;">
                            ğŸ›¡ï¸ ãƒ‡ãƒ¼ã‚¿ã®å®‰å…¨æ€§ï¼ˆãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»å¾©å…ƒï¼‰
                        </summary>
                        <div
                            style="padding:16px; background:var(--card-bg); border-radius:0 0 12px 12px; margin-top:-4px; border:1px solid var(--border); border-top:none;">
                            <div class="backup-controls">
                                <button class="backup-btn" id="exportJsonBtn">ğŸ“¤ JSONã§å…¨ä¿å­˜</button>
                                <button class="backup-btn" onclick="document.getElementById('importFile').click()">ğŸ“¥
                                    JSONã‹ã‚‰å¾©å…ƒ</button>
                                <input type="file" id="importFile" class="hidden" accept=".json">
                                <button class="backup-btn" id="exportAllCsvBtn">ğŸ“Š å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼CSV</button>
                            </div>
                            <p style="font-size:0.75rem; color:var(--text-muted); margin-top:12px;">
                                â€»å¾©å…ƒã‚’è¡Œã†ã¨ç¾åœ¨ã®ãƒ–ãƒ©ã‚¦ã‚¶ä¸Šã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚
                            </p>
                        </div>
                    </details>

                    <!-- ç¿’æ…£åŒ–ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ -->
                    <details style="margin-bottom:8px;">
                        <summary
                            style="cursor:pointer; font-weight:700; font-size:0.95rem; padding:12px; background:var(--bg); border-radius:12px; display:flex; align-items:center; gap:8px;">
                            ğŸ“Š ç¿’æ…£åŒ–ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆ
                        </summary>
                        <div
                            style="padding:16px; background:var(--card-bg); border-radius:0 0 12px 12px; margin-top:-4px; border:1px solid var(--border); border-top:none;">
                            <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:16px;">
                                æœŸé–“ã‚’æŒ‡å®šã—ã¦ã€AIã«ã‚ˆã‚‹åˆ†æãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™ã€‚
                            </p>
                            <div style="margin-bottom:16px;">
                                <label
                                    style="font-size:0.8rem; font-weight:700; display:block; margin-bottom:8px;">å¯¾è±¡ãƒ¦ãƒ¼ã‚¶ãƒ¼</label>
                                <select id="reportUserSelect" class="modal-select" style="width:100%; padding:12px;">
                                    <option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ...</option>
                                </select>
                            </div>
                            <div style="margin-bottom:16px;">
                                <label
                                    style="font-size:0.8rem; font-weight:700; display:block; margin-bottom:8px;">ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“</label>
                                <div style="display:flex; gap:8px; margin-bottom:8px; flex-wrap:wrap;">
                                    <button class="period-btn" onclick="selectPeriod('thisMonth')">ä»Šæœˆ</button>
                                    <button class="period-btn" onclick="selectPeriod('lastMonth')">å…ˆæœˆ</button>
                                    <button class="period-btn" onclick="selectPeriod('last30days')">éå»30æ—¥</button>
                                </div>

                                <!-- é–‹å§‹æ—¥è¨­å®šï¼ˆç¿’æ…£åŒ–é–‹å§‹æ—¥ï¼‰ -->
                                <div
                                    style="background:var(--bg); padding:12px; border-radius:12px; margin-bottom:12px;">
                                    <label
                                        style="font-size:0.75rem; font-weight:700; display:block; margin-bottom:6px; color:var(--text-muted);">
                                        ğŸ“… ç¿’æ…£åŒ–é–‹å§‹æ—¥ï¼ˆåˆæœŸè¨­å®šï¼‰
                                    </label>
                                    <input type="date" id="habitStartDate" class="modal-input"
                                        style="width:100%; margin-bottom:8px;">

                                    <!-- ãƒ—ãƒ©ãƒ³è¡¨ç¤ºãƒ©ãƒ™ãƒ« -->
                                    <div id="planLabel"
                                        style="font-size:0.8rem; font-weight:700; margin-bottom:8px; color:var(--primary); text-align:center; display:none;">
                                    </div>

                                    <!-- 3ãƒ¶æœˆã‚³ãƒ¼ã‚¹ï¼ˆ1ã€œ3ãƒ¶æœˆï¼‰ -->
                                    <div id="plan3months" style="margin-bottom:6px;">
                                        <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:4px;">
                                            3ãƒ¶æœˆã‚³ãƒ¼ã‚¹</div>
                                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                                            <button class="period-btn month-btn" data-month="1"
                                                onclick="setMonthReport(1)"
                                                style="flex:1; font-size:0.75rem; padding:6px;">1ãƒ¶æœˆ</button>
                                            <button class="period-btn month-btn" data-month="2"
                                                onclick="setMonthReport(2)"
                                                style="flex:1; font-size:0.75rem; padding:6px;">2ãƒ¶æœˆ</button>
                                            <button class="period-btn month-btn" data-month="3"
                                                onclick="setMonthReport(3)"
                                                style="flex:1; font-size:0.75rem; padding:6px;">3ãƒ¶æœˆ</button>
                                        </div>
                                    </div>

                                    <!-- 6ãƒ¶æœˆã‚³ãƒ¼ã‚¹ï¼ˆ4ã€œ6ãƒ¶æœˆï¼‰ -->
                                    <div id="plan6months" style="margin-bottom:6px; display:none;">
                                        <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:4px;">
                                            6ãƒ¶æœˆã‚³ãƒ¼ã‚¹</div>
                                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                                            <button class="period-btn month-btn" data-month="4"
                                                onclick="setMonthReport(4)"
                                                style="flex:1; font-size:0.75rem; padding:6px;">4ãƒ¶æœˆ</button>
                                            <button class="period-btn month-btn" data-month="5"
                                                onclick="setMonthReport(5)"
                                                style="flex:1; font-size:0.75rem; padding:6px;">5ãƒ¶æœˆ</button>
                                            <button class="period-btn month-btn" data-month="6"
                                                onclick="setMonthReport(6)"
                                                style="flex:1; font-size:0.75rem; padding:6px;">6ãƒ¶æœˆ</button>
                                        </div>
                                    </div>

                                    <!-- 9ãƒ¶æœˆã‚³ãƒ¼ã‚¹ï¼ˆ7ã€œ9ãƒ¶æœˆï¼‰ -->
                                    <div id="plan9months" style="display:none;">
                                        <div style="font-size:0.7rem; color:var(--text-muted); margin-bottom:4px;">
                                            9ãƒ¶æœˆã‚³ãƒ¼ã‚¹</div>
                                        <div style="display:flex; gap:6px; flex-wrap:wrap;">
                                            <button class="period-btn month-btn" data-month="7"
                                                onclick="setMonthReport(7)"
                                                style="flex:1; font-size:0.75rem; padding:6px;">7ãƒ¶æœˆ</button>
                                            <button class="period-btn month-btn" data-month="8"
                                                onclick="setMonthReport(8)"
                                                style="flex:1; font-size:0.75rem; padding:6px;">8ãƒ¶æœˆ</button>
                                            <button class="period-btn month-btn" data-month="9"
                                                onclick="setMonthReport(9)"
                                                style="flex:1; font-size:0.75rem; padding:6px;">9ãƒ¶æœˆ</button>
                                        </div>
                                    </div>

                                    <p id="periodNote"
                                        style="font-size:0.65rem; color:var(--text-muted); margin-top:8px; line-height:1.4;">
                                        â€» ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã™ã‚‹ã¨ã€ãƒ—ãƒ©ãƒ³ã«å¿œã˜ãŸãƒ¬ãƒãƒ¼ãƒˆæœˆãŒè¡¨ç¤ºã•ã‚Œã¾ã™
                                    </p>
                                </div>

                                <!-- æ‰‹å‹•æœŸé–“è¨­å®š -->
                                <label
                                    style="font-size:0.75rem; font-weight:600; display:block; margin-bottom:6px; color:var(--text-muted);">
                                    ã¾ãŸã¯æ‰‹å‹•ã§æœŸé–“ã‚’æŒ‡å®šï¼š
                                </label>
                                <div style="display:flex; gap:8px; align-items:center;">
                                    <input type="date" id="reportStartDate" class="modal-input" style="flex:1;">
                                    <span style="color:var(--text-muted);">ã€œ</span>
                                    <input type="date" id="reportEndDate" class="modal-input" style="flex:1;">
                                </div>
                            </div>

                            <div style="margin-bottom:16px;">
                                <label
                                    style="font-size:0.8rem; font-weight:700; display:block; margin-bottom:8px;">Gemini
                                    APIè¨­å®šï¼ˆä»»æ„ï¼‰</label>
                                <input type="text" id="geminiApiKey" placeholder="Gemini API Keyï¼ˆç©ºæ¬„ã§AIåˆ†æã‚’ã‚¹ã‚­ãƒƒãƒ—ï¼‰"
                                    class="modal-input" style="width:100%;">
                                <p style="font-size:0.75rem; color:var(--text-muted); margin-top:4px;">
                                    â€» ç©ºæ¬„ã«ã™ã‚‹ã¨AIåˆ†æã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã€ãƒ‡ãƒ¼ã‚¿ã¨ã‚°ãƒ©ãƒ•ã®ã¿ã®ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¾ã™
                                </p>
                            </div>
                            <div id="reportStatus"
                                style="display:none; margin-bottom:16px; padding:12px; border-radius:12px; background:var(--bg); font-size:0.85rem;">
                            </div>
                            <button class="btn-3d btn-primary" id="generateReportBtn" onclick="generateReport()"
                                style="width:100%;">
                                ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’é–‹å§‹
                            </button>
                        </div>
                    </details>
                </div>
            </details>
        </div>


        <!-- å‰Šé™¤ç¢ºèªãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="confirmModal">
            <div class="modal">
                <h3 id="modalTitle">âš ï¸ å‰Šé™¤ç¢ºèª</h3>
                <p id="modalMsg" style="color:var(--text-muted); margin-top:8px;"></p>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" id="confirmCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="modal-btn danger" id="confirmOk">å®Ÿè¡Œ</button>
                </div>
            </div>
        </div>

        <div class="toast" id="toast"></div>

        <script>
            const USERS_KEY = 'habitTracker_users';
            const BASE_URL_KEY = 'habitTracker_baseUrl';

            // JSONbin.ioè¨­å®š
            const JSONBIN_MASTER_KEY = '$2a$10$9gCdL3y87QxebgxH9Ea1eOT93VPPLvVcj/czCK0PaWCL3WLhOutcC';
            const USERS_BIN_ID = '69678ac9d0ea881f406b5bc5';
            const JSONBIN_API = 'https://api.jsonbin.io/v3/b';

            function loadUsers() {
                const data = localStorage.getItem(USERS_KEY);
                return data ? JSON.parse(data) : { users: [] };
            }

            function saveUsers(data) {
                localStorage.setItem(USERS_KEY, JSON.stringify(data));
                // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚åŒæœŸï¼ˆå…¬é–‹URLã‚‚å«ã‚ã‚‹ï¼‰
                syncAllDataToCloud();
            }

            // å…¨ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆ + å…¬é–‹URLï¼‰ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ä¿å­˜
            async function syncAllDataToCloud() {
                try {
                    const usersData = loadUsers();
                    const baseUrl = localStorage.getItem(BASE_URL_KEY) || '';
                    const allData = {
                        users: usersData.users,
                        baseUrl: baseUrl
                    };
                    await fetch(`${JSONBIN_API}/${USERS_BIN_ID}`, {
                        method: 'PUT',
                        body: JSON.stringify(allData),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_MASTER_KEY
                        }
                    });
                    console.log('All data synced to cloud');
                } catch (e) { console.error('Cloud Sync Error:', e); }
            }

            // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
            async function fetchAllDataFromCloud() {
                try {
                    const res = await fetch(`${JSONBIN_API}/${USERS_BIN_ID}/latest`, {
                        headers: { 'X-Master-Key': JSONBIN_MASTER_KEY }
                    });
                    if (res.ok) {
                        const response = await res.json();
                        if (response.record) {
                            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’ä¿å­˜
                            if (response.record.users) {
                                localStorage.setItem(USERS_KEY, JSON.stringify({ users: response.record.users }));

                                // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Bin IDã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ã‚‚ä¿å­˜
                                for (const user of response.record.users) {
                                    if (user.binId) {
                                        localStorage.setItem(`habitTracker_binId_${user.id}`, user.binId);
                                        userBinIds[user.id] = user.binId;
                                    }
                                }
                            }
                            // å…¬é–‹URLã‚’ä¿å­˜
                            if (response.record.baseUrl) {
                                localStorage.setItem(BASE_URL_KEY, response.record.baseUrl);
                            }
                            console.log('All data fetched from cloud');
                            return true;
                        }
                    }
                } catch (e) { console.warn('Cloud Fetch Failed:', e); }
                return false;
            }

            function loadUserData(userId) {
                const data = localStorage.getItem(`habitTracker_${userId}`);
                return data ? JSON.parse(data) : { habits: [], logs: [] };
            }

            // å„ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ç”¨ã®ã‚¯ãƒ©ã‚¦ãƒ‰APIï¼ˆå‹•çš„Binä½œæˆï¼‰
            const userBinIds = {};

            async function getOrCreateUserBin(userId) {
                // ã¾ãšãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‹ã‚‰å–å¾—ã‚’è©¦ã¿ã‚‹
                const usersData = loadUsers();
                const user = usersData.users.find(u => u.id === userId);
                if (user && user.binId) {
                    localStorage.setItem(`habitTracker_binId_${userId}`, user.binId);
                    userBinIds[userId] = user.binId;
                    return user.binId;
                }

                // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚ã‚Œã°è¿”ã™
                const cacheKey = `habitTracker_binId_${userId}`;
                const cachedId = localStorage.getItem(cacheKey) || userBinIds[userId];
                if (cachedId) {
                    // ãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã«ã‚‚ä¿å­˜
                    if (user && !user.binId) {
                        user.binId = cachedId;
                        saveUsers(usersData);
                    }
                    return cachedId;
                }

                // æ–°è¦Binä½œæˆ
                try {
                    const res = await fetch(JSONBIN_API, {
                        method: 'POST',
                        body: JSON.stringify({ habits: [], logs: [] }),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_MASTER_KEY,
                            'X-Bin-Name': `habit_user_${userId}`
                        }
                    });
                    if (res.ok) {
                        const data = await res.json();
                        const binId = data.metadata.id;
                        localStorage.setItem(cacheKey, binId);
                        userBinIds[userId] = binId;

                        // ãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã«ã‚‚binIdã‚’ä¿å­˜
                        if (user) {
                            user.binId = binId;
                            saveUsers(usersData);
                        }
                        console.log('Created new bin:', binId);
                        return binId;
                    }
                } catch (e) { console.error('Create user bin error:', e); }
                return null;
            }

            async function syncUserDataToCloud(userId, data) {
                const binId = await getOrCreateUserBin(userId);
                if (!binId) return;
                try {
                    await fetch(`${JSONBIN_API}/${binId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_MASTER_KEY
                        }
                    });
                } catch (e) { console.error('User data sync error:', e); }
            }

            async function fetchUserDataFromCloud(userId) {
                const binId = localStorage.getItem(`habitTracker_binId_${userId}`) || userBinIds[userId];
                if (!binId) return null;
                try {
                    const res = await fetch(`${JSONBIN_API}/${binId}/latest`, {
                        headers: { 'X-Master-Key': JSONBIN_MASTER_KEY }
                    });
                    if (res.ok) {
                        const response = await res.json();
                        if (response.record) {
                            localStorage.setItem(`habitTracker_${userId}`, JSON.stringify(response.record));
                            return response.record;
                        }
                    }
                } catch (e) { console.warn('User data fetch error:', e); }
                return null;
            }

            // é”æˆç‡ãƒ­ã‚¸ãƒƒã‚¯ (Ver 8.0 ç›®æ¨™å±¥æ­´ & ä¸€æ™‚åœæ­¢å¯¾å¿œ)
            function getDateKey(date = new Date()) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2,
                    '0')}`;
            }
            function getGoalAtDate(habit, dateKey) {
                if (!habit.goalHistory) return habit.goal || 5;
                const history = [...habit.goalHistory].sort((a, b) => new Date(a.date) - new Date(b.date));
                let activeGoal = history[0].value;
                for (const entry of history) {
                    if (entry.date <= dateKey) { activeGoal = entry.value; } else { break; }
                } return activeGoal;
            } function
                getDailyPct(data, dateKey) {
                const activeHabits = data.habits.filter(h => !h.isPaused && (h.startDate ||
                    '2026-01-01') <= dateKey); if (activeHabits.length === 0) return 0; let total = 0; activeHabits.forEach(h => {
                        const dayLogs = data.logs.filter(l => l.habit === h.name && l.timestamp.split('T')[0] === dateKey);
                        const current = dayLogs.reduce((sum, l) => sum + (l.value || 1), 0);
                        const goal = getGoalAtDate(h, dateKey);
                        total += Math.min(1, current / goal);
                    });
                return Math.round((total / activeHabits.length) * 100);
            }

            function showToast(msg) {
                const t = document.getElementById('toast');
                t.textContent = msg; t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 2000);
            }

            function createProgressRing(pct) {
                const r = 24, c = 2 * Math.PI * r;
                const offset = c - (pct / 100) * c;
                const color = pct >= 80 ? 'var(--success)' : pct >= 50 ? 'var(--warning)' : 'var(--danger)';
                return `
            <div class="progress-ring">
                <svg width="60" height="60">
                    <circle class="bg" cx="30" cy="30" r="${r}" />
                    <circle class="fg" cx="30" cy="30" r="${r}" stroke-dasharray="${c}" stroke-dashoffset="${offset}"
                        style="stroke: ${color}" />
                </svg>
                <span class="pct" style="color: ${color}">${pct}%</span>
            </div>`;
            }

            function renderUsers() {
                const usersData = loadUsers();
                const userList = document.getElementById('userList');
                if (usersData.users.length === 0) {
                    userList.innerHTML = '<div style="text-align:center;padding:48px;color:var(--text-muted);">ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</div>';
                    return;
                }

                // å…¬é–‹URLè¨­å®šã‚’å–å¾—ã€ãªã‘ã‚Œã°ç¾åœ¨ã®URLã‚’ä½¿ç”¨
                const savedBaseUrl = localStorage.getItem('habitTracker_baseUrl');
                const baseUrl = savedBaseUrl ? (savedBaseUrl.endsWith('/') ? savedBaseUrl + 'index.html' : savedBaseUrl +
                    '/index.html') : new URL('index.html', window.location.href).href;
                const today = getDateKey();

                userList.innerHTML = `
            <div style="margin-bottom:16px; text-align:right;">
                <button class="action-btn sync" onclick="syncAllUsers()">ğŸ”„ å…¨ã¦åŒæœŸ (ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—)</button>
            </div>
            ` + usersData.users.map(user => {
                    const userData = loadUserData(user.id);
                    const pct = getDailyPct(userData, today);

                    // çµŒéæ—¥æ•°è¨ˆç®—
                    const start = user.startDate || today;
                    const elapsedDays = Math.max(0, Math.floor((new Date(today) - new Date(start)) / (1000 * 60 * 60 * 24)));

                    // è¨˜éŒ²æ—¥æ•°ï¼ˆå ±å‘ŠãŒã‚ã£ãŸæ—¥ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯æ•°ï¼‰
                    const reportedDays = new Set(userData.logs.map(l => l.timestamp.split('T')[0])).size;

                    // é–‹å§‹æ—¥ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
                    const startDateFormatted = user.startDate
                        ? new Date(user.startDate).toLocaleDateString('ja-JP', { month: 'short', day: 'numeric' })
                        : 'æœªè¨­å®š';

                    const localBaseUrl = new URL('index.html', window.location.href).href;
                    const localUrl = `${localBaseUrl}?user=${user.id}`;
                    const publicUrl = `${baseUrl}?user=${user.id}`;

                    // ãƒ—ãƒ©ãƒ³ãƒ©ãƒ™ãƒ«
                    const planLabel = user.plan ? {
                        '3months': '3ãƒ¶æœˆ',
                        '6months': '6ãƒ¶æœˆ',
                        '9months': '9ãƒ¶æœˆ'
                    }[user.plan] || user.plan : 'æœªè¨­å®š';

                    const planBadgeColor = user.plan ? {
                        '3months': '#10b981',
                        '6months': '#3b82f6',
                        '9months': '#8b5cf6'
                    }[user.plan] || 'var(--text-muted)' : 'var(--text-muted)';

                    return `
            <div class="user-card" onclick="window.open('${localUrl}', '_blank')">
                <div class="user-info">
                    <div style="display:flex; align-items:center; gap:8px; margin-bottom:8px;">
                        <div class="user-name">${user.name}</div>
                        <span style="font-size:0.7rem; background:${planBadgeColor}; color:white; padding:2px 8px; border-radius:10px;">${planLabel}</span>
                    </div>
                    <div class="user-stats-container">
                        <div class="user-stat-row">é–‹å§‹æ—¥: <b style="color:${user.startDate ? 'var(--duo-blue)' : 'var(--text-muted)'}">${startDateFormatted}</b></div>
                        <div class="user-stat-row">çµŒéæ—¥æ•°: <b>${elapsedDays}æ—¥</b></div>
                        <div class="user-stat-row">è¨˜éŒ²æ—¥æ•°: <b>${reportedDays}æ—¥</b></div>
                    </div>
                </div>
                <div class="user-stats">
                    ${createProgressRing(pct)}
                </div>
                <div class="menu-container" onclick="event.stopPropagation()">
                    <button class="menu-btn" onclick="toggleMenu('${user.id}')">â‹®</button>
                    <div class="dropdown-menu" id="menu-${user.id}">
                        <div class="dropdown-item" onclick="setUserStartDate('${user.id}', '${user.name}')">ğŸ“… é–‹å§‹æ—¥è¨­å®š</div>
                        <div class="dropdown-item" onclick="setUserPlan('${user.id}', '${user.name}')">ğŸ“‹ ãƒ—ãƒ©ãƒ³å¤‰æ›´</div>
                        <div class="dropdown-item" onclick="openRemoteEdit('${user.id}')">âœï¸ ç·¨é›†</div>
                        <div class="dropdown-item" onclick="window.open('${localUrl}', '_blank')">ğŸ‘ï¸ è¡¨ç¤º</div>
                        <div class="dropdown-item" onclick="showShareOptions('${publicUrl}', '${user.name}')">ğŸ”— å…±æœ‰ãƒªãƒ³ã‚¯ç™ºè¡Œ
                        </div>
                        <div class="dropdown-item delete" onclick="confirmDeleteUser('${user.id}', '${user.name}')">ğŸ—‘ï¸
                            å‰Šé™¤</div>
                    </div>
                </div>
            </div>`;
                }).join('');
            }

            window.toggleMenu = (id) => {
                const menu = document.getElementById(`menu-${id}`);
                const isShowing = menu.classList.contains('show');

                // å…¨ã¦ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã¦ã€ã‚«ãƒ¼ãƒ‰ã®z-indexã‚’ãƒªã‚»ãƒƒãƒˆ
                document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
                document.querySelectorAll('.user-card').forEach(c => c.style.zIndex = '');

                if (!isShowing) {
                    menu.classList.add('show');
                    // è¦ªã‚«ãƒ¼ãƒ‰ã®z-indexã‚’ä¸Šã’ã‚‹
                    const card = menu.closest('.user-card');
                    if (card) card.style.zIndex = '100';
                }
            };

            // ã©ã“ã‹ã‚’å©ã„ãŸã‚‰ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‰ã˜ã‚‹
            window.onclick = (e) => {
                if (!e.target.matches('.menu-btn')) {
                    document.querySelectorAll('.dropdown-menu').forEach(m => m.classList.remove('show'));
                    document.querySelectorAll('.user-card').forEach(c => c.style.zIndex = '');
                }
            };

            window.showShareOptions = (url, name) => {
                // å…¬é–‹URLãŒè¨­å®šã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                const savedBaseUrl = localStorage.getItem('habitTracker_baseUrl');
                if (!savedBaseUrl || url.startsWith('file://')) {
                    showToast('âš ï¸ å…ˆã«å…¬é–‹URLè¨­å®šã‚’è¡Œã£ã¦ãã ã•ã„');
                    // ç”»é¢ä¸Šéƒ¨ã«ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                    document.getElementById('baseUrlInput').focus();
                    return;
                }

                // ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
                const linkModal = document.getElementById('linkModal');
                const linkUrlDisplay = document.getElementById('linkUrlDisplay');
                const linkTitle = document.getElementById('linkTitle');

                linkTitle.textContent = `${name}ã•ã‚“ã®å…±æœ‰ãƒªãƒ³ã‚¯`;
                linkUrlDisplay.value = url;
                linkModal.classList.add('show');
            };

            window.copyLinkUrl = () => {
                const linkUrlDisplay = document.getElementById('linkUrlDisplay');
                linkUrlDisplay.select();
                document.execCommand('copy');
                showToast('ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            };

            window.closeLinkModal = () => {
                document.getElementById('linkModal').classList.remove('show');
            };

            function shareUrl(url, name) {
                if (navigator.share) {
                    navigator.share({ title: `${name}ã•ã‚“ã®ç¿’æ…£`, url: url }).catch(() => { });
                } else {
                    copyUrl(url);
                }
            }

            function showQR(url, name) {
                const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=250x250&data=${encodeURIComponent(url)}`;
                document.getElementById('qrImage').src = qrUrl;
                document.getElementById('qrTitle').textContent = `${name}ã•ã‚“ã®QRã‚³ãƒ¼ãƒ‰`;
                document.getElementById('qrModal').classList.add('show');
            }

            function copyUrl(url) {
                navigator.clipboard.writeText(url);
                showToast('URLã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
            }

            let confirmAction = null;
            const confirmModal = document.getElementById('confirmModal');
            function showConfirm(title, msg, onOk) {
                document.getElementById('modalTitle').textContent = title;
                document.getElementById('modalMsg').textContent = msg;
                confirmAction = onOk;
                confirmModal.classList.add('show');
            }
            document.getElementById('confirmCancel').onclick = () => confirmModal.classList.remove('show');
            document.getElementById('confirmOk').onclick = () => {
                try {
                    if (confirmAction) confirmAction();
                } catch (e) {
                    console.error(e);
                } finally {
                    confirmModal.classList.remove('show');
                }
            };

            window.confirmDeleteUser = (id, name) => {
                showConfirm('ğŸ‘¤ ãƒ¦ãƒ¼ã‚¶ãƒ¼å‰Šé™¤', `ã€Œ${name}ã€ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`, () => {
                    const usersData = loadUsers();
                    usersData.users = usersData.users.filter(u => u.id !== id);
                    saveUsers(usersData);
                    localStorage.removeItem(`habitTracker_${id}`);
                    renderUsers();
                    showToast('å‰Šé™¤ã—ã¾ã—ãŸ');
                });
            };

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®é–‹å§‹æ—¥ã‚’è¨­å®š
            window.setUserStartDate = (userId, userName) => {
                const usersData = loadUsers();
                const user = usersData.users.find(u => u.id === userId);
                const currentDate = user?.startDate || '';

                // æ—¥ä»˜è¨­å®šç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ç”¨
                const newDate = prompt(
                    `${userName}ã•ã‚“ã®ç¿’æ…£åŒ–é–‹å§‹æ—¥ã‚’è¨­å®šã—ã¦ãã ã•ã„\nï¼ˆå½¢å¼: YYYY-MM-DDï¼‰`,
                    currentDate || new Date().toISOString().split('T')[0]
                );

                if (newDate !== null) {
                    // æ—¥ä»˜å½¢å¼ã‚’ãƒã‚§ãƒƒã‚¯
                    if (/^\d{4}-\d{2}-\d{2}$/.test(newDate)) {
                        usersData.users = usersData.users.map(u =>
                            u.id === userId ? { ...u, startDate: newDate } : u
                        );
                        saveUsers(usersData);
                        renderUsers();
                        updateReportUserSelect();
                        showToast(`${userName}ã•ã‚“ã®é–‹å§‹æ—¥ã‚’ ${newDate} ã«è¨­å®šã—ã¾ã—ãŸ`);
                    } else if (newDate.trim() === '') {
                        // ç©ºæ¬„ã®å ´åˆã¯é–‹å§‹æ—¥ã‚’ã‚¯ãƒªã‚¢
                        usersData.users = usersData.users.map(u => {
                            if (u.id === userId) {
                                const { startDate, ...rest } = u;
                                return rest;
                            }
                            return u;
                        });
                        saveUsers(usersData);
                        renderUsers();
                        updateReportUserSelect();
                        showToast(`${userName}ã•ã‚“ã®é–‹å§‹æ—¥ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ`);
                    } else {
                        showToast('æ­£ã—ã„æ—¥ä»˜å½¢å¼ã§å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆYYYY-MM-DDï¼‰');
                    }
                }
            };

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³ã‚’è¨­å®š
            window.setUserPlan = (userId, userName) => {
                const usersData = loadUsers();
                const user = usersData.users.find(u => u.id === userId);
                const currentPlan = user?.plan || '3months';

                // ãƒ—ãƒ©ãƒ³é¸æŠç”¨ã®ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½¿ç”¨
                const planOptions = `
1: 3ãƒ¶æœˆã‚³ãƒ¼ã‚¹
2: 6ãƒ¶æœˆã‚³ãƒ¼ã‚¹
3: 9ãƒ¶æœˆã‚³ãƒ¼ã‚¹`;

                const choice = prompt(
                    `${userName}ã•ã‚“ã®å—è¬›ãƒ—ãƒ©ãƒ³ã‚’é¸æŠã—ã¦ãã ã•ã„\n${planOptions}\n\nç•ªå·ã‚’å…¥åŠ›:`,
                    currentPlan === '3months' ? '1' : currentPlan === '6months' ? '2' : '3'
                );

                if (choice !== null) {
                    const planMap = { '1': '3months', '2': '6months', '3': '9months' };
                    const newPlan = planMap[choice.trim()];

                    if (newPlan) {
                        usersData.users = usersData.users.map(u =>
                            u.id === userId ? { ...u, plan: newPlan } : u
                        );
                        saveUsers(usersData);
                        renderUsers();
                        showToast(`${userName}ã•ã‚“ã®ãƒ—ãƒ©ãƒ³ã‚’ ${getPlanLabel(newPlan)} ã«å¤‰æ›´ã—ã¾ã—ãŸ`);
                    } else {
                        showToast('1, 2, 3 ã®ã„ãšã‚Œã‹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    }
                }
            };

            document.getElementById('addForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const input = document.getElementById('userInput');
                const startDateInput = document.getElementById('userStartDate');
                const planSelect = document.getElementById('userPlan');

                const name = input.value.trim();
                if (!name) return;

                const startDate = startDateInput.value || getDateKey();
                const plan = planSelect.value || '3months';

                const usersData = loadUsers();
                const newUserId = Math.random().toString(36).substr(2, 8);

                // æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’è¿½åŠ ï¼ˆbinIdã¯å¾Œã§è¨­å®šï¼‰
                const newUser = {
                    id: newUserId,
                    name,
                    startDate,
                    plan,
                    binId: null // ä¸€æ—¦nullã§ä½œæˆ
                };
                usersData.users.push(newUser);
                saveUsers(usersData);

                // ãƒ•ã‚©ãƒ¼ãƒ ã‚’ãƒªã‚»ãƒƒãƒˆ
                input.value = '';
                startDateInput.value = '';
                planSelect.value = '3months';

                renderUsers();
                showToast(`ã€Œ${name}ã€ã‚’ä½œæˆã—ã¾ã—ãŸï¼ˆ${getPlanLabel(plan)}ï¼‰`);

                // éåŒæœŸã§Bin IDã‚’ç”Ÿæˆã—ã¦ãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã«ä¿å­˜
                (async () => {
                    try {
                        const res = await fetch(JSONBIN_API, {
                            method: 'POST',
                            body: JSON.stringify({ habits: [], logs: [] }),
                            headers: {
                                'Content-Type': 'application/json',
                                'X-Master-Key': JSONBIN_MASTER_KEY,
                                'X-Bin-Name': `habit_user_${newUserId}`
                            }
                        });
                        if (res.ok) {
                            const data = await res.json();
                            const binId = data.metadata.id;

                            // ãƒã‚¹ã‚¿ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
                            const updatedUsersData = loadUsers();
                            const user = updatedUsersData.users.find(u => u.id === newUserId);
                            if (user) {
                                user.binId = binId;
                                saveUsers(updatedUsersData);
                                console.log(`Created binId for user ${name}: ${binId}`);
                            }

                            // ãƒ­ãƒ¼ã‚«ãƒ«ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«ã‚‚ä¿å­˜
                            localStorage.setItem(`habitTracker_binId_${newUserId}`, binId);
                        }
                    } catch (e) {
                        console.error('Failed to create bin for new user:', e);
                    }
                })();
            });

            // ãƒ—ãƒ©ãƒ³ã®ãƒ©ãƒ™ãƒ«ã‚’å–å¾—
            function getPlanLabel(plan) {
                const labels = {
                    '3months': '3ãƒ¶æœˆã‚³ãƒ¼ã‚¹',
                    '6months': '6ãƒ¶æœˆã‚³ãƒ¼ã‚¹',
                    '9months': '9ãƒ¶æœˆã‚³ãƒ¼ã‚¹'
                };
                return labels[plan] || plan;
            }

            // JSONãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
            document.getElementById('exportJsonBtn').onclick = () => {
                const allData = {};
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i); if
                        (key.startsWith('habitTracker_')) { allData[key] = JSON.parse(localStorage.getItem(key)); }
                } const
                    blob = new Blob([JSON.stringify(allData, null, 2)], { type: 'application/json' }); const
                        link = document.createElement('a'); link.href = URL.createObjectURL(blob);
                link.download = `HabitTracker_Backup_${getDateKey()}.json`; link.click(); showToast('JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
            };
            document.getElementById('importFile').onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const data = JSON.parse(ev.target.result);
                        showConfirm('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿å¾©å…ƒ', 'ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã€ä¸Šæ›¸ãå¾Œã«ãƒšãƒ¼ã‚¸ãŒãƒªãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã™ã€‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ', () => {
                            Object.keys(data).forEach(key => {
                                if (key.startsWith('habitTracker_')) {
                                    localStorage.setItem(key, JSON.stringify(data[key]));
                                }
                            });
                            location.reload();
                        });
                    } catch (err) {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                    }
                };
                reader.readAsText(file);
                e.target.value = '';
            };

            // CSVã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            document.getElementById('exportAllCsvBtn').onclick = () => {
                const usersData = loadUsers();
                let csv = 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å,ç¿’æ…£å,å‹,å€¤,æ—¥æ™‚\n';
                usersData.users.forEach(u => {
                    const data = loadUserData(u.id);
                    data.logs.forEach(l => {
                        const h = data.habits.find(hx => hx.name === l.habit);
                        csv += `${u.name},${l.habit},${h ? h.type : '-'},${l.value || 1},${l.timestamp}\n`;
                    });
                });
                const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `All_Users_Log_${getDateKey()}.csv`;
                link.click();
                showToast('CSVã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            };

            // é éš”ç·¨é›†
            let currentEditingUserId = null;
            let remoteEditModal = null;

            async function syncToCloud(userId, data) {
                const binId = await getOrCreateUserBin(userId);
                if (!binId) {
                    showToast('ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return;
                }
                try {
                    await fetch(`${JSONBIN_API}/${binId}`, {
                        method: 'PUT',
                        body: JSON.stringify(data),
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Master-Key': JSONBIN_MASTER_KEY
                        }
                    });
                } catch (e) {
                    console.error('Cloud sync failed:', e);
                    showToast('ã‚¯ãƒ©ã‚¦ãƒ‰åŒæœŸã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            async function fetchLatestData(userId) {
                const binId = localStorage.getItem(`habitTracker_binId_${userId}`) || userBinIds[userId];
                if (!binId) {
                    showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    return;
                }
                try {
                    const response = await fetch(`${JSONBIN_API}/${binId}/latest`, {
                        headers: { 'X-Master-Key': JSONBIN_MASTER_KEY }
                    });
                    if (response.ok) {
                        const result = await response.json();
                        if (result.record) {
                            localStorage.setItem(`habitTracker_${userId}`, JSON.stringify(result.record));
                            showToast(`ã€Œ${loadUsers().users.find(u => u.id === userId).name}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—ã—ã¾ã—ãŸ`);
                        }
                    } else {
                        showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
                    }
                } catch (error) {
                    console.error('Error fetching cloud data:', error);
                    showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            }

            window.syncAllUsers = async () => {
                showToast('å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸä¸­...');
                const usersData = loadUsers();

                for (const user of usersData.users) {
                    // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆï¼‰
                    const localData = loadUserData(user.id);
                    if (localData && (localData.habits.length > 0 || localData.logs.length > 0)) {
                        console.log(`Pushing local data to cloud: ${user.name}`);
                        await syncUserDataToCloud(user.id, localData);
                    }
                }

                // æ¬¡ã«ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
                for (const user of usersData.users) {
                    await fetchLatestData(user.id);
                }

                renderUsers();
                showToast('å…¨ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’åŒæœŸã—ã¾ã—ãŸ');
            };

            window.addRemoteHabit = () => {
                const nameInput = document.getElementById('newHabitName');
                const typeInput = document.getElementById('newHabitType');
                const name = nameInput.value.trim();
                if (!name) return;

                const data = loadUserData(currentEditingUserId);
                if (data.habits.some(h => h.name === name)) {
                    alert('æ—¢ã«åŒã˜åå‰ã®ç¿’æ…£ãŒã‚ã‚Šã¾ã™');
                    return;
                }

                const goal = typeInput.value === 'check' ? 1 : 5;
                data.habits.push({
                    name: name,
                    type: typeInput.value,
                    goal: goal,
                    startDate: getDateKey(),
                    isPaused: false,
                    goalHistory: [{ date: getDateKey(), value: goal }]
                });

                localStorage.setItem(`habitTracker_${currentEditingUserId}`, JSON.stringify(data));
                nameInput.value = '';
                openRemoteEdit(currentEditingUserId);
                renderUsers();
                showToast('ç¿’æ…£ã‚’è¿½åŠ ã—ã¾ã—ãŸ');
            };

            window.openRemoteEdit = async (id) => {
                currentEditingUserId = id;
                showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ä¸­...');
                await fetchLatestData(id);
                const data = loadUserData(id);
                const usersData = loadUsers();
                const user = usersData.users.find(u => u.id === id);

                document.getElementById('editUserName').value = user.name || '';
                document.getElementById('editUserStart').value = user.startDate || '';

                const list = document.getElementById('remoteHabitList');
                if (data.habits.length === 0) {
                    list.innerHTML = '<p style="padding:10px;">ç¿’æ…£ãŒã‚ã‚Šã¾ã›ã‚“</p>';
                } else {
                    list.innerHTML = data.habits.map((h, i) => `
                <div class="habit-edit-item">
                    <input type="text" value="${h.name}" onchange="updateRemoteHabitName(${i}, this.value)">
                    <span style="font-size:0.8rem; opacity:0.6;">(${h.type})</span>
                </div>
                `).join('');
                }
                remoteEditModal.classList.add('show');
            };

            window.updateRemoteHabitName = (idx, newName) => {
                const data = loadUserData(currentEditingUserId);
                const oldName = data.habits[idx].name;
                if (newName && newName !== oldName) {
                    data.logs.forEach(l => { if (l.habit === oldName) l.habit = newName; });
                    data.habits[idx].name = newName;
                    localStorage.setItem(`habitTracker_${currentEditingUserId}`, JSON.stringify(data));
                }
            };

            // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«Bin IDãŒãªã„å ´åˆã€è‡ªå‹•ä¿®å¾©
            // ã¾ãŸã€æ—¢å­˜ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ—ãƒƒã‚·ãƒ¥
            async function repairMissingBinIds() {
                const usersData = loadUsers();
                let needsSync = false;

                for (const user of usersData.users) {
                    if (!user.binId) {
                        console.log(`Repairing missing binId for user: ${user.name}`);
                        const binId = await getOrCreateUserBin(user.id);
                        if (binId) {
                            user.binId = binId;
                            needsSync = true;

                            // ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ—ãƒƒã‚·ãƒ¥
                            const localData = loadUserData(user.id);
                            if (localData && (localData.habits.length > 0 || localData.logs.length > 0)) {
                                console.log(`Pushing local data to cloud for user: ${user.name}`);
                                await syncUserDataToCloud(user.id, localData);
                            }
                        }
                    }
                }

                if (needsSync) {
                    saveUsers(usersData);
                    console.log('Bin ID repair completed and synced to cloud');
                }
            }

            // åˆæœŸåŒ–ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’å…ˆã«è¡¨ç¤ºã€ãã®å¾Œã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰æ›´æ–°ï¼‰
            async function init() {
                // ã¾ãšãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã§è¡¨ç¤ºï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“å‘ä¸Šï¼‰
                const baseUrlInput = document.getElementById('baseUrlInput');
                if (baseUrlInput) {
                    baseUrlInput.value = localStorage.getItem('habitTracker_baseUrl') || '';
                }
                renderUsers();

                // ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿å–å¾—
                try {
                    const success = await fetchAllDataFromCloud();
                    if (success) {
                        // ã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿ã§æ›´æ–°
                        if (baseUrlInput) {
                            baseUrlInput.value = localStorage.getItem('habitTracker_baseUrl') || '';
                        }
                        renderUsers();
                    }

                    // æ—¢å­˜ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®Bin IDä¿®å¾©ï¼ˆã‚¯ãƒ©ã‚¦ãƒ‰ãƒ‡ãƒ¼ã‚¿å–å¾—å¾Œã«å®Ÿè¡Œï¼‰
                    await repairMissingBinIds();

                    // ãƒ­ãƒ¼ã‚«ãƒ«ã«ã‚ã‚‹ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ—ãƒƒã‚·ãƒ¥ï¼ˆè‡ªå‹•åŒæœŸï¼‰
                    await pushAllLocalDataToCloud();

                    // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—
                    await fetchAllUsersDataFromCloud();
                    renderUsers();

                } catch (e) {
                    console.error('Init error:', e);
                }
            }

            // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ã‚«ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã«ãƒ—ãƒƒã‚·ãƒ¥
            async function pushAllLocalDataToCloud() {
                const usersData = loadUsers();
                for (const user of usersData.users) {
                    if (user.binId) {
                        const localData = loadUserData(user.id);
                        if (localData && (localData.habits.length > 0 || localData.logs.length > 0)) {
                            console.log(`Auto-pushing local data to cloud: ${user.name}`);
                            await syncUserDataToCloud(user.id, localData);
                        }
                    }
                }
            }

            // å…¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒ©ã‚¦ãƒ‰ã‹ã‚‰å–å¾—ã—ã¦ãƒ­ãƒ¼ã‚«ãƒ«ã‚’æ›´æ–°
            async function fetchAllUsersDataFromCloud() {
                const usersData = loadUsers();
                for (const user of usersData.users) {
                    if (user.binId) {
                        await fetchUserDataFromCloud(user.id);
                    }
                }
                console.log('All users data fetched from cloud');
            }

            // DOMContentLoaded ã§ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã®å‚ç…§ã¨ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ã‚’è¨­å®š
            document.addEventListener('DOMContentLoaded', () => {
                // ãƒ¢ãƒ¼ãƒ€ãƒ«è¦ç´ ã®å‚ç…§è¨­å®š
                remoteEditModal = document.getElementById('remoteEditModal');

                const remoteEditConfirmBtn = document.getElementById('remoteEditConfirm');
                const remoteEditCancelBtn = document.getElementById('remoteEditCancel');

                if (remoteEditConfirmBtn) {
                    remoteEditConfirmBtn.onclick = async () => {
                        const newUserName = document.getElementById('editUserName').value.trim();
                        const newUserStart = document.getElementById('editUserStart').value;

                        if (newUserName) {
                            const usersData = loadUsers();
                            const user = usersData.users.find(u => u.id === currentEditingUserId);
                            if (user) {
                                user.name = newUserName;
                                user.startDate = newUserStart;
                                saveUsers(usersData);
                            }
                        }

                        const data = loadUserData(currentEditingUserId);
                        showToast('ã‚¯ãƒ©ã‚¦ãƒ‰ã«åæ˜ ä¸­...');
                        await syncToCloud(currentEditingUserId, data);

                        remoteEditModal.classList.remove('show');
                        renderUsers();
                        showToast('ä¿å­˜ã—ã¾ã—ãŸ');
                    };
                }

                if (remoteEditCancelBtn) {
                    remoteEditCancelBtn.onclick = () => remoteEditModal.classList.remove('show');
                }

                // åˆæœŸåŒ–å®Ÿè¡Œ
                init();
            });

            // å…¬é–‹URLä¿å­˜æ©Ÿèƒ½
            window.saveBaseUrl = () => {
                const url = document.getElementById('baseUrlInput').value.trim();
                if (!url) {
                    showToast('URLã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }
                localStorage.setItem('habitTracker_baseUrl', url);
                // ã‚¯ãƒ©ã‚¦ãƒ‰ã«ã‚‚åŒæœŸ
                syncAllDataToCloud();
                showToast('å…¬é–‹URLã‚’è¨­å®šã—ã¾ã—ãŸ');
                renderUsers();
            };

            // å®šæœŸçš„ãªUIæ›´æ–°
            setInterval(renderUsers, 30000);

            // ==============================
            // ç¿’æ…£åŒ–ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆæ©Ÿèƒ½
            // ==============================

            // ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ãƒ•ãƒ©ã‚°ï¼ˆäºŒé‡å®Ÿè¡Œé˜²æ­¢ï¼‰
            let isGeneratingReport = false;

            // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠãƒªã‚¹ãƒˆã‚’æ›´æ–°
            function updateReportUserSelect() {
                const select = document.getElementById('reportUserSelect');
                if (!select) return;
                const usersData = loadUsers();
                select.innerHTML = '<option value="">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠ...</option>' +
                    usersData.users.map(u => `<option value="${u.id}" data-start-date="${u.startDate || ''}" data-plan="${u.plan || '3months'}">${u.name}</option>`).join('');

                // ãƒ¦ãƒ¼ã‚¶ãƒ¼é¸æŠæ™‚ã«é–‹å§‹æ—¥ã¨ãƒ—ãƒ©ãƒ³ã‚’è‡ªå‹•è¨­å®š
                select.onchange = () => {
                    const selectedOption = select.options[select.selectedIndex];
                    const startDate = selectedOption?.dataset?.startDate;
                    const plan = selectedOption?.dataset?.plan || '3months';
                    const habitStartInput = document.getElementById('habitStartDate');

                    if (startDate && habitStartInput) {
                        habitStartInput.value = startDate;
                    }

                    // ç¾åœ¨ã®ãƒ—ãƒ©ãƒ³ã‚’ä¿å­˜
                    currentUserPlan = plan;

                    // ãƒ—ãƒ©ãƒ³ã«å¿œã˜ã¦ãƒ¬ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º/éè¡¨ç¤º
                    updateReportButtonsByPlan(plan);

                    if (startDate) {
                        showToast(`é–‹å§‹æ—¥ã‚’ ${startDate} ã«è‡ªå‹•è¨­å®šã—ã¾ã—ãŸï¼ˆ${getPlanLabel(plan)}ï¼‰`);
                    }
                };
            }

            // ãƒ—ãƒ©ãƒ³ã«å¿œã˜ã¦ãƒ¬ãƒãƒ¼ãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º/éè¡¨ç¤º
            function updateReportButtonsByPlan(plan) {
                const plan3months = document.getElementById('plan3months');
                const plan6months = document.getElementById('plan6months');
                const plan9months = document.getElementById('plan9months');
                const planLabel = document.getElementById('planLabel');
                const periodNote = document.getElementById('periodNote');

                // ã™ã¹ã¦éè¡¨ç¤ºã«ãƒªã‚»ãƒƒãƒˆ
                plan3months.style.display = 'none';
                plan6months.style.display = 'none';
                plan9months.style.display = 'none';

                // ãƒ—ãƒ©ãƒ³ãƒ©ãƒ™ãƒ«ã‚’è¡¨ç¤º
                const planLabels = {
                    '3months': 'ğŸ“‹ 3ãƒ¶æœˆã‚³ãƒ¼ã‚¹',
                    '6months': 'ğŸ“‹ 6ãƒ¶æœˆã‚³ãƒ¼ã‚¹',
                    '9months': 'ğŸ“‹ 9ãƒ¶æœˆã‚³ãƒ¼ã‚¹'
                };
                planLabel.textContent = planLabels[plan] || planLabels['3months'];
                planLabel.style.display = 'block';

                // ãƒ—ãƒ©ãƒ³ã«å¿œã˜ã¦è¡¨ç¤º
                switch (plan) {
                    case '9months':
                        plan9months.style.display = 'block';
                    // ãƒ•ã‚©ãƒ¼ãƒ«ã‚¹ãƒ«ãƒ¼
                    case '6months':
                        plan6months.style.display = 'block';
                    // ãƒ•ã‚©ãƒ¼ãƒ«ã‚¹ãƒ«ãƒ¼
                    case '3months':
                    default:
                        plan3months.style.display = 'block';
                        break;
                }

                // èª¬æ˜æ–‡ã‚’æ›´æ–°
                periodNote.innerHTML = 'â€» å„æœˆ30æ—¥é–“ãšã¤ï¼ˆ1ãƒ¶æœˆç›®: 1ã€œ30æ—¥ç›®ã€2ãƒ¶æœˆç›®: 31ã€œ60æ—¥ç›®...ï¼‰';
            }

            // æœŸé–“é¸æŠãƒœã‚¿ãƒ³
            window.selectPeriod = (period) => {
                const today = new Date();
                const startInput = document.getElementById('reportStartDate');
                const endInput = document.getElementById('reportEndDate');
                let start, end;

                // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
                document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                switch (period) {
                    case 'thisWeek':
                        const dayOfWeek = today.getDay();
                        start = new Date(today);
                        start.setDate(today.getDate() - dayOfWeek);
                        end = new Date(today);
                        break;
                    case 'lastWeek':
                        const lastWeekEnd = new Date(today);
                        lastWeekEnd.setDate(today.getDate() - today.getDay() - 1);
                        start = new Date(lastWeekEnd);
                        start.setDate(lastWeekEnd.getDate() - 6);
                        end = lastWeekEnd;
                        break;
                    case 'thisMonth':
                        start = new Date(today.getFullYear(), today.getMonth(), 1);
                        end = new Date(today);
                        break;
                    case 'lastMonth':
                        start = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                        end = new Date(today.getFullYear(), today.getMonth(), 0);
                        break;
                    case 'last30days':
                        start = new Date(today);
                        start.setDate(today.getDate() - 29);
                        end = new Date(today);
                        break;
                }

                startInput.value = formatDate(start);
                endInput.value = formatDate(end);
            };

            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¬ãƒãƒ¼ãƒˆæœˆï¼ˆ1ã€œ9ï¼‰  
            let currentReportMonth = null;
            // ç¾åœ¨é¸æŠã•ã‚Œã¦ã„ã‚‹ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ—ãƒ©ãƒ³
            let currentUserPlan = '3months';

            // æœˆåˆ¥ãƒ¬ãƒãƒ¼ãƒˆè¨­å®šï¼ˆ1ãƒ¶æœˆç›®ã€œ9ãƒ¶æœˆç›®ï¼‰
            // 1ãƒ¶æœˆç›®: é–‹å§‹æ—¥ã‹ã‚‰30æ—¥é–“ï¼ˆ1æ—¥ç›®ã€œ30æ—¥ç›®ï¼‰
            // 2ãƒ¶æœˆç›®: 31æ—¥ç›®ã‹ã‚‰60æ—¥ç›®ï¼ˆ30æ—¥é–“ï¼‰
            // 3ãƒ¶æœˆç›®: 61æ—¥ç›®ã‹ã‚‰90æ—¥ç›®ï¼ˆ30æ—¥é–“ï¼‰
            // 4ãƒ¶æœˆç›®ã€œ9ãƒ¶æœˆç›®: ä»¥é™30æ—¥ãšã¤
            window.setMonthReport = (monthNum) => {
                const habitStartInput = document.getElementById('habitStartDate');
                const startInput = document.getElementById('reportStartDate');
                const endInput = document.getElementById('reportEndDate');

                if (!habitStartInput.value) {
                    showToast('ç¿’æ…£åŒ–é–‹å§‹æ—¥ã‚’è¨­å®šã—ã¦ãã ã•ã„');
                    habitStartInput.focus();
                    return;
                }

                const habitStart = new Date(habitStartInput.value);
                let start, end, daysInfo;

                // æœŸé–“è¨­å®šï¼ˆå„æœˆ30æ—¥é–“ãšã¤ï¼‰
                // 1ãƒ¶æœˆç›®: 1æ—¥ç›®ã€œ30æ—¥ç›®
                // 2ãƒ¶æœˆç›®: 31æ—¥ç›®ã€œ60æ—¥ç›®
                // 3ãƒ¶æœˆç›®: 61æ—¥ç›®ã€œ90æ—¥ç›®
                // ...
                const startDay = (monthNum - 1) * 30 + 1; // 1, 31, 61, 91, 121, 151, 181, 211, 241
                const endDay = monthNum * 30; // 30, 60, 90, 120, 150, 180, 210, 240, 270

                start = new Date(habitStart);
                start.setDate(habitStart.getDate() + startDay - 1);
                end = new Date(habitStart);
                end.setDate(habitStart.getDate() + endDay - 1);
                daysInfo = `${startDay}æ—¥ç›®ã€œ${endDay}æ—¥ç›®ï¼ˆ30æ—¥é–“ï¼‰`;

                startInput.value = formatDate(start);
                endInput.value = formatDate(end);

                // æœˆç•ªå·ã‚’ä¿å­˜
                currentReportMonth = monthNum;

                // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
                document.querySelectorAll('.period-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');

                showToast(`${monthNum}ãƒ¶æœˆç›®ã®ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆ${daysInfo}ï¼‰`);
            };

            function formatDate(date) {
                return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
            }

            // APIè¨­å®šã‚’ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜ãƒ»å¾©å…ƒ
            function saveApiSettings() {
                localStorage.setItem('report_geminiApiKey', document.getElementById('geminiApiKey').value);
            }

            function loadApiSettings() {
                document.getElementById('geminiApiKey').value = localStorage.getItem('report_geminiApiKey') || '';
            }

            // ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤º
            function updateReportStatus(message, type = 'info') {
                const statusEl = document.getElementById('reportStatus');
                statusEl.style.display = 'block';
                statusEl.innerHTML = message;
                statusEl.style.background = type === 'error' ? 'rgba(239,68,68,0.1)' :
                    type === 'success' ? 'rgba(34,197,94,0.1)' :
                        'var(--bg)';
                statusEl.style.color = type === 'error' ? 'var(--danger)' :
                    type === 'success' ? 'var(--success)' :
                        'var(--text)';
            }

            // ãƒ¡ã‚¤ãƒ³ã®ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆé–¢æ•°
            window.generateReport = async () => {
                if (isGeneratingReport) {
                    showToast('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆä¸­ã§ã™...');
                    return;
                }

                const userId = document.getElementById('reportUserSelect').value;
                const startDate = document.getElementById('reportStartDate').value;
                const endDate = document.getElementById('reportEndDate').value;
                const geminiApiKey = document.getElementById('geminiApiKey').value;

                // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
                if (!userId) {
                    showToast('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                if (!startDate || !endDate) {
                    showToast('æœŸé–“ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }
                if (startDate > endDate) {
                    showToast('æœŸé–“ãŒä¸æ­£ã§ã™');
                    return;
                }
                // Gemini APIã‚­ãƒ¼ã¯ã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼ˆç©ºæ¬„ãªã‚‰AIåˆ†æã‚¹ã‚­ãƒƒãƒ—ï¼‰
                const skipAiAnalysis = !geminiApiKey;

                // APIè¨­å®šã‚’ä¿å­˜
                saveApiSettings();

                isGeneratingReport = true;
                const btn = document.getElementById('generateReportBtn');
                btn.disabled = true;
                btn.textContent = 'â³ ç”Ÿæˆä¸­...';

                try {
                    const aiStepLabel = skipAiAnalysis ? 'ï¼ˆã‚¹ã‚­ãƒƒãƒ—ï¼‰' : '';
                    updateReportStatus(`
                    <div class="report-progress">
                        <div class="progress-step active">ğŸ“Š ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºä¸­...</div>
                        <div class="progress-step pending">ğŸ¤– AIåˆ†æ${aiStepLabel}...</div>
                        <div class="progress-step pending">ğŸ“ˆ ã‚°ãƒ©ãƒ•ç”Ÿæˆä¸­...</div>
                        <div class="progress-step pending">ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ä¸­...</div>
                    </div>
                `);

                    // Step 1: ãƒ‡ãƒ¼ã‚¿æŠ½å‡º
                    const usersData = loadUsers();
                    const user = usersData.users.find(u => u.id === userId);
                    const userData = loadUserData(userId);
                    const reportData = extractReportData(userData, startDate, endDate, user);

                    if (reportData.logs.length === 0) {
                        throw new Error('æŒ‡å®šæœŸé–“å†…ã«è¨˜éŒ²ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    }

                    updateReportStatus(`
                    <div class="report-progress">
                        <div class="progress-step done">âœ“ ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå®Œäº†ï¼ˆ${reportData.logs.length}ä»¶ï¼‰</div>
                        <div class="progress-step active">ğŸ¤– AIåˆ†æ${aiStepLabel}...</div>
                        <div class="progress-step pending">ğŸ“ˆ ã‚°ãƒ©ãƒ•ç”Ÿæˆä¸­...</div>
                        <div class="progress-step pending">ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ä¸­...</div>
                    </div>
                `);

                    // Step 2: AIåˆ†æï¼ˆã‚¹ã‚­ãƒƒãƒ—å¯èƒ½ï¼‰
                    let analysis;
                    if (skipAiAnalysis) {
                        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ†æãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
                        analysis = generateDefaultAnalysis(reportData, user.name, currentReportMonth, currentUserPlan);
                    } else {
                        try {
                            analysis = await analyzeWithGemini(reportData, geminiApiKey, user.name);
                        } catch (aiError) {
                            console.warn('AIåˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã®åˆ†æã‚’ä½¿ç”¨ã—ã¾ã™:', aiError);
                            analysis = generateDefaultAnalysis(reportData, user.name, currentReportMonth, currentUserPlan);
                        }
                    }

                    updateReportStatus(`
                    <div class="report-progress">
                        <div class="progress-step done">âœ“ ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå®Œäº†</div>
                        <div class="progress-step ${skipAiAnalysis ? 'skipped' : 'done'}">âœ“ ${skipAiAnalysis ? 'AIåˆ†æã‚¹ã‚­ãƒƒãƒ—' : 'AIåˆ†æå®Œäº†'}</div>
                        <div class="progress-step active">ğŸ“ˆ ã‚°ãƒ©ãƒ•ç”Ÿæˆä¸­...</div>
                        <div class="progress-step pending">ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ä¸­...</div>
                    </div>
                `);

                    // Step 3: ã‚°ãƒ©ãƒ•ç”»åƒç”Ÿæˆ
                    const chartImages = await generateChartImages(reportData);
                    console.log('ã‚°ãƒ©ãƒ•ç”Ÿæˆå®Œäº†');

                    updateReportStatus(`
                    <div class="report-progress">
                        <div class="progress-step done">âœ“ ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå®Œäº†</div>
                        <div class="progress-step ${skipAiAnalysis ? 'skipped' : 'done'}">âœ“ ${skipAiAnalysis ? 'AIåˆ†æã‚¹ã‚­ãƒƒãƒ—' : 'AIåˆ†æå®Œäº†'}</div>
                        <div class="progress-step done">âœ“ ã‚°ãƒ©ãƒ•ç”Ÿæˆå®Œäº†</div>
                        <div class="progress-step active">ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ä¸­...</div>
                    </div>
                `);

                    // Step 4: ãƒ¬ãƒãƒ¼ãƒˆä½œæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰
                    const result = await createReport(
                        user.name,
                        startDate,
                        endDate,
                        analysis,
                        reportData,
                        chartImages
                    );

                    // Markdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
                    const markdownReport = generateReportMarkdown(user.name, startDate, endDate, analysis, reportData);

                    // çµæœè¡¨ç¤ºï¼ˆå¸¸ã«ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰
                    const resultMessage = `
                        <div style="margin-top:12px;">
                            <p style="color:var(--duo-green); font-weight:700;">âœ… ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆå®Œäº†</p>
                            <p style="font-size:0.8rem; color:var(--text-muted); margin-top:8px;">
                                HTMLãƒ•ã‚¡ã‚¤ãƒ«: ${result.fileName}<br>
                                â€» ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒ•ã‚©ãƒ«ãƒ€ã‚’ç¢ºèªã—ã¦ãã ã•ã„
                            </p>
                            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn-3d btn-primary" onclick="showReportModal(currentReportText)" style="font-size:0.85rem;">
                                    ğŸ“‹ ã‚³ãƒ”ãƒ¼ç”¨ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤º
                                </button>
                            </div>
                            <div style="margin-top:12px; display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn-3d btn-primary" onclick="downloadAllImages()" style="font-size:0.8rem;">
                                    ğŸ“¦ å…¨ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                                </button>
                            </div>
                            <div style="margin-top:8px; display:flex; gap:8px; flex-wrap:wrap;">
                                <button class="btn-3d" onclick="downloadSummaryCard()" style="font-size:0.8rem;">
                                    ğŸ¯ ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰
                                </button>
                                <button class="btn-3d" onclick="downloadChartImage('weekday')" style="font-size:0.8rem;">
                                    ğŸ“Š æ›œæ—¥åˆ¥ã‚°ãƒ©ãƒ•
                                </button>
                                <button class="btn-3d" onclick="downloadChartImage('habit')" style="font-size:0.8rem;">
                                    ğŸ“ˆ ç¿’æ…£åˆ¥ã‚°ãƒ©ãƒ•
                                </button>
                                <button class="btn-3d" onclick="downloadWeekdayTable()" style="font-size:0.8rem;">
                                    ğŸ—‚ï¸ æ›œæ—¥åˆ¥è¡¨
                                </button>
                            </div>
                        </div>
                    `;

                    // ãƒ¢ãƒ¼ãƒ€ãƒ«ç”¨ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿å­˜
                    currentReportText = markdownReport;

                    // ã‚°ãƒ©ãƒ•ç”»åƒã‚’ä¿å­˜ï¼ˆãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ç”¨ï¼‰
                    window.currentChartImages = chartImages;

                    // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ç”Ÿæˆï¼ˆã‚°ãƒ©ãƒ•ç”»åƒä¿å­˜å¾Œã«å®Ÿè¡Œï¼‰
                    try {
                        await generateSummaryCardImage(reportData);
                        console.log('ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†ã€currentChartImages:', window.currentChartImages);
                    } catch (e) {
                        console.error('ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼:', e);
                    }

                    // æ›œæ—¥åˆ¥è¡¨ç”Ÿæˆ
                    try {
                        await generateHabitWeekdayTableImage(reportData);
                        console.log('æ›œæ—¥åˆ¥è¡¨ç”Ÿæˆå®Œäº†ã€currentChartImages:', window.currentChartImages);
                    } catch (e) {
                        console.error('æ›œæ—¥åˆ¥è¡¨ç”Ÿæˆã§ã‚¨ãƒ©ãƒ¼:', e);
                    }

                    updateReportStatus(`
                    <div class="report-progress">
                        <div class="progress-step done">âœ“ ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå®Œäº†</div>
                        <div class="progress-step ${skipAiAnalysis ? 'skipped' : 'done'}">âœ“ ${skipAiAnalysis ? 'AIåˆ†æã‚¹ã‚­ãƒƒãƒ—' : 'AIåˆ†æå®Œäº†'}</div>
                        <div class="progress-step done">âœ“ ã‚°ãƒ©ãƒ•ç”Ÿæˆå®Œäº†</div>
                        <div class="progress-step done">âœ“ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›å®Œäº†</div>
                    </div>
                    ${resultMessage}
                `, 'success');

                    // ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è‡ªå‹•çš„ã«è¡¨ç¤º
                    showReportModal(markdownReport);

                    showToast('ãƒ¬ãƒãƒ¼ãƒˆç”ŸæˆãŒå®Œäº†ã—ã¾ã—ãŸï¼');

                } catch (error) {
                    console.error('Report generation error:', error);
                    updateReportStatus(`âŒ ã‚¨ãƒ©ãƒ¼: ${error.message}`, 'error');
                    showToast('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                } finally {
                    isGeneratingReport = false;
                    btn.disabled = false;
                    btn.textContent = 'ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã‚’é–‹å§‹';
                }
            };

            // ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºãƒ»åŠ å·¥
            function extractReportData(userData, startDate, endDate, user) {
                const habits = userData.habits || [];

                // ç¿’æ…£åã‹ã‚‰ç¿’æ…£ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’å–å¾—ã™ã‚‹ãŸã‚ã®ãƒãƒƒãƒ—
                const habitMap = {};
                habits.forEach(h => {
                    habitMap[h.name] = h;
                });

                // ãƒ­ã‚°ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆæœŸé–“å†… ã‹ã¤ ç¿’æ…£ã®é–‹å§‹æ—¥ä»¥é™ï¼‰
                const logs = (userData.logs || []).filter(log => {
                    const logDate = log.timestamp.split('T')[0];
                    // æœŸé–“å†…ãƒã‚§ãƒƒã‚¯
                    if (logDate < startDate || logDate > endDate) return false;

                    // ç¿’æ…£ã®é–‹å§‹æ—¥ä»¥é™ã‹ãƒã‚§ãƒƒã‚¯
                    const habit = habitMap[log.habit];
                    if (habit && habit.startDate && logDate < habit.startDate) {
                        console.log(`é™¤å¤–: ${log.habit} ã® ${logDate} ã¯é–‹å§‹æ—¥ ${habit.startDate} ã‚ˆã‚Šå‰`);
                        return false;
                    }

                    return true;
                });

                // æ—¥ä»˜ã”ã¨ã«ã‚°ãƒ«ãƒ¼ãƒ—åŒ–ã—ã€é‡è¤‡æ’é™¤ï¼ˆæœ€æ–°å„ªå…ˆï¼‰
                const logsByDateHabit = {};
                logs.forEach(log => {
                    const dateKey = log.timestamp.split('T')[0];
                    const habitKey = log.habit;
                    const key = `${dateKey}_${habitKey}`;
                    if (!logsByDateHabit[key] || log.timestamp > logsByDateHabit[key].timestamp) {
                        logsByDateHabit[key] = log;
                    }
                });
                const deduplicatedLogs = Object.values(logsByDateHabit);

                // é€±ã”ã¨ã®è¨ˆç®—ï¼ˆåˆå›å ±å‘Šæ—¥ã‚’èµ·ç‚¹ï¼‰
                const uniqueDates = [...new Set(deduplicatedLogs.map(l => l.timestamp.split('T')[0]))].sort();
                const firstReportDate = uniqueDates[0] || startDate;

                // ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“ä¸­ã®ç·æ—¥æ•°ã‚’è¨ˆç®—ï¼ˆæœªæ¥ã®æ—¥ã¯å«ã‚ãªã„ï¼‰
                const startD = new Date(startDate);
                const endD = new Date(endDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // å®Ÿéš›ã®çµ‚äº†æ—¥ã¯ã€æŒ‡å®šçµ‚äº†æ—¥ã¨ä»Šæ—¥ã®å°ã•ã„æ–¹
                const actualEndD = endD > today ? today : endD;
                const totalPeriodDays = Math.max(1, Math.floor((actualEndD - startD) / (1000 * 60 * 60 * 24)) + 1);

                // æœŸé–“ä¸­ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç¿’æ…£ã‚’ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
                // æ¡ä»¶: 
                // 1. å‰Šé™¤ã•ã‚Œã¦ã„ãªã„ï¼ˆã¾ãŸã¯æœŸé–“ä¸­ã«å‰Šé™¤ã•ã‚ŒãŸï¼‰
                // 2. é–‹å§‹æ—¥ãŒãƒ¬ãƒãƒ¼ãƒˆæœŸé–“çµ‚äº†æ—¥ä»¥å‰
                const activeHabits = habits.filter(h => {
                    // å‰Šé™¤æ¸ˆã¿ã®ç¿’æ…£ã¯é™¤å¤–ï¼ˆdeletedAtãŒã‚ã‚Šã€ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“é–‹å§‹å‰ã«å‰Šé™¤ã•ã‚ŒãŸå ´åˆï¼‰
                    if (h.deletedAt && h.deletedAt < startDate) return false;

                    // é–‹å§‹æ—¥ãŒãƒ¬ãƒãƒ¼ãƒˆæœŸé–“çµ‚äº†æ—¥ã‚ˆã‚Šå¾Œã®ç¿’æ…£ã¯é™¤å¤–
                    if (h.startDate && h.startDate > endDate) return false;

                    // ãã‚Œä»¥å¤–ã¯å«ã‚ã‚‹
                    return true;
                });

                // ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“ä¸­ã«è¨˜éŒ²ãŒã‚ã‚‹ç¿’æ…£åã®ãƒªã‚¹ãƒˆï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
                const habitsWithLogs = [...new Set(deduplicatedLogs.map(l => l.habit))];

                console.log('å…¨ç¿’æ…£:', habits.map(h => `${h.name}(é–‹å§‹:${h.startDate || 'ãªã—'})`));
                console.log('æœŸé–“ä¸­ã«ãƒ­ã‚°ãŒã‚ã‚‹ç¿’æ…£:', habitsWithLogs);
                console.log('ã‚°ãƒ©ãƒ•ã«è¡¨ç¤ºã™ã‚‹ç¿’æ…£:', activeHabits.map(h => h.name));

                // é€±ã”ã¨ã®è¨ˆç®—ï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ç¿’æ…£ã‚’ä½¿ç”¨ï¼‰
                const weeklyData = calculateWeeklyStats(deduplicatedLogs, activeHabits, firstReportDate);

                // æ›œæ—¥åˆ¥é›†è¨ˆï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ç¿’æ…£ã‚’ä½¿ç”¨ï¼‰
                const dayOfWeekStats = calculateDayOfWeekStats(deduplicatedLogs, activeHabits, startDate, endDate);

                // 2æ—¥é€£ç¶šå¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆï¼ˆãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°æ¸ˆã¿ç¿’æ…£ã‚’ä½¿ç”¨ï¼‰
                const consecutiveFailures = calculateConsecutiveFailures(deduplicatedLogs, activeHabits, startDate, endDate);

                // ç¿’æ…£åˆ¥ã®çµ±è¨ˆï¼ˆé”æˆå‰²åˆã®å¹³å‡ã€è¨˜éŒ²ãŒãªã„æ—¥ã¯0%ã¨ã—ã¦è¨ˆç®—ï¼‰
                const habitStats = activeHabits.map(h => {
                    const habitLogs = deduplicatedLogs.filter(l => l.habit === h.name);
                    const recordedDays = habitLogs.length;

                    // ã“ã®ç¿’æ…£ã®å®Ÿéš›ã®å¯¾è±¡æ—¥æ•°ã‚’è¨ˆç®—ï¼ˆç¿’æ…£ã®é–‹å§‹æ—¥ã¨ä¸€æ™‚åœæ­¢ã‚’è€ƒæ…®ï¼‰
                    const habitStartD = h.startDate ? new Date(h.startDate) : startD;
                    const actualHabitStartD = habitStartD > startD ? habitStartD : startD;

                    // ä¸€æ™‚åœæ­¢æ—¥ã‚’è€ƒæ…®ã—ãŸçµ‚äº†æ—¥ã‚’è¨ˆç®—
                    let habitEndD = new Date(actualEndD);
                    let pauseStatus = null;

                    if (h.isPaused && h.pausedDate) {
                        const pausedD = new Date(h.pausedDate);
                        if (pausedD <= actualEndD && pausedD >= actualHabitStartD) {
                            // ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“ä¸­ã«ä¸€æ™‚åœæ­¢ã•ã‚ŒãŸ
                            habitEndD = new Date(pausedD);
                            habitEndD.setDate(habitEndD.getDate() - 1); // åœæ­¢æ—¥ã®å‰æ—¥ã¾ã§
                            pauseStatus = 'paused_during'; // æœŸé–“ä¸­ã«ä¸€æ™‚åœæ­¢
                        } else if (pausedD < actualHabitStartD) {
                            // ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“å‰ã‹ã‚‰ä¸€æ™‚åœæ­¢ä¸­
                            pauseStatus = 'paused_before'; // æœŸé–“å‰ã‹ã‚‰åœæ­¢ä¸­
                        }
                    }

                    const habitTotalDays = pauseStatus === 'paused_before'
                        ? 0
                        : Math.max(0, Math.floor((habitEndD - actualHabitStartD) / (1000 * 60 * 60 * 24)) + 1);

                    // é”æˆå‰²åˆã®åˆè¨ˆã‚’è¨ˆç®—ï¼ˆæœŸé–“å†…ã®å…¨æ—¥ã‚’å¯¾è±¡ï¼‰
                    let totalPct = 0;
                    for (let d = new Date(actualHabitStartD); d <= habitEndD; d.setDate(d.getDate() + 1)) {
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const dk = `${year}-${month}-${day}`;

                        // ã“ã®æ—¥ã®ãƒ­ã‚°ã‚’æ¤œç´¢
                        const log = habitLogs.find(l => l.timestamp.split('T')[0] === dk);
                        if (log) {
                            const goal = getGoalAtDate(h, dk);
                            const pct = goal > 0 ? Math.min(1, log.value / goal) : 0;
                            totalPct += pct * 100;
                        }
                        // ãƒ­ã‚°ãŒãªã„æ—¥ã¯0%ï¼ˆtotalPctã«åŠ ç®—ã—ãªã„ï¼‰
                    }

                    // é”æˆç‡ã¯ã€Œé”æˆå‰²åˆã®åˆè¨ˆ / å¯¾è±¡æ—¥æ•°ã€ã§è¨ˆç®—
                    return {
                        name: h.name,
                        type: h.type,
                        color: h.color || '#0891B2',
                        totalDays: habitTotalDays,
                        recordedDays,
                        rate: habitTotalDays > 0 ? Math.round(totalPct / habitTotalDays) : 0,
                        isPaused: h.isPaused || false,
                        pauseStatus: pauseStatus // null, 'paused_during', 'paused_before'
                    };
                });

                // ç¿’æ…£åˆ¥Ã—æ›œæ—¥åˆ¥æˆåŠŸç‡ã‚’è¨ˆç®—
                const habitDayOfWeekStats = calculateHabitDayOfWeekStats(deduplicatedLogs, activeHabits, startDate, endDate);

                return {
                    user,
                    startDate,
                    endDate,
                    habits: activeHabits,  // æœŸé–“ä¸­ã«ãƒ­ã‚°ãŒã‚ã‚‹ç¿’æ…£ã®ã¿
                    logs: deduplicatedLogs,
                    weeklyData,
                    dayOfWeekStats,
                    consecutiveFailures,
                    habitStats,
                    uniqueDates,
                    habitDayOfWeekStats
                };
            }

            // é€±ã”ã¨ã®çµ±è¨ˆè¨ˆç®—
            function calculateWeeklyStats(logs, habits, firstReportDate) {
                const weeks = {};
                const startDate = new Date(firstReportDate);

                logs.forEach(log => {
                    const logDate = new Date(log.timestamp.split('T')[0]);
                    const weekNum = Math.floor((logDate - startDate) / (7 * 24 * 60 * 60 * 1000)) + 1;
                    const weekKey = `week${weekNum}`;

                    if (!weeks[weekKey]) {
                        weeks[weekKey] = { total: 0, achieved: 0, logs: [] };
                    }
                    weeks[weekKey].logs.push(log);
                    weeks[weekKey].total++;

                    const habit = habits.find(h => h.name === log.habit);
                    if (habit) {
                        const goal = getGoalAtDate(habit, log.timestamp.split('T')[0]);
                        if (log.value >= goal) {
                            weeks[weekKey].achieved++;
                        }
                    }
                });

                return weeks;
            }

            // æ›œæ—¥åˆ¥çµ±è¨ˆï¼ˆæœŸé–“ãƒ™ãƒ¼ã‚¹ã§è¨ˆç®—ã€ã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨åŒã˜æ—¥åˆ¥é”æˆç‡ã®å¹³å‡ï¼‰
            function calculateDayOfWeekStats(logs, habits, startDate, endDate) {
                const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                const stats = days.map(() => ({ total: 0, count: 0 })); // total: é”æˆç‡ã®åˆè¨ˆ, count: æ—¥æ•°

                // ä»Šæ—¥ã®æ—¥ä»˜
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                // å®Ÿéš›ã®çµ‚äº†æ—¥ã¯ã€æŒ‡å®šçµ‚äº†æ—¥ã¨ä»Šæ—¥ã®å°ã•ã„æ–¹
                const startD = new Date(startDate);
                const endD = new Date(endDate);
                const actualEndD = endD > today ? today : endD;

                // æœŸé–“å†…ã®å…¨æ—¥ã‚’å¯¾è±¡ã«è¨ˆç®—
                for (let d = new Date(startD); d <= actualEndD; d.setDate(d.getDate() + 1)) {
                    // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜ã‚’å–å¾—
                    const year = d.getFullYear();
                    const month = String(d.getMonth() + 1).padStart(2, '0');
                    const day = String(d.getDate()).padStart(2, '0');
                    const dk = `${year}-${month}-${day}`;
                    const dayIdx = d.getDay();

                    // ã“ã®æ—¥ã®é”æˆç‡ã‚’è¨ˆç®—ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨åŒã˜æ–¹æ³•ï¼šå„ç¿’æ…£ã®é”æˆå‰²åˆã®å¹³å‡ï¼‰
                    let dayTotalPct = 0; // é”æˆå‰²åˆã®åˆè¨ˆ
                    let dayHabitCount = 0; // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãªç¿’æ…£æ•°

                    habits.forEach(habit => {
                        // ç¿’æ…£ã®é–‹å§‹æ—¥ã‚ˆã‚Šå‰ã¯ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
                        if (habit.startDate && dk < habit.startDate) return;

                        // ä¸€æ™‚åœæ­¢ä¸­ã®ç¿’æ…£ã¯åœæ­¢æ—¥ä»¥é™ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
                        if (habit.isPaused && habit.pausedDate && dk >= habit.pausedDate) return;

                        dayHabitCount++;

                        // ã“ã®æ—¥ã®ãƒ­ã‚°ã‚’æ¤œç´¢
                        const log = logs.find(l => l.habit === habit.name && l.timestamp.split('T')[0] === dk);
                        if (log) {
                            const goal = getGoalAtDate(habit, dk);
                            // é”æˆå‰²åˆã‚’è¨ˆç®—ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨åŒã˜ã€ã‚¼ãƒ­é™¤ç®—é˜²æ­¢ï¼‰
                            const pct = goal > 0 ? Math.min(1, log.value / goal) : 0;
                            dayTotalPct += pct;
                        }
                        // ãƒ­ã‚°ãŒãªã„å ´åˆã¯0%ï¼ˆdayTotalPctã«åŠ ç®—ã—ãªã„ï¼‰
                    });

                    // ã“ã®æ—¥ã®é”æˆç‡ã‚’è¨ˆç®—ï¼ˆã‚«ãƒ¬ãƒ³ãƒ€ãƒ¼ã¨åŒã˜ï¼šå„ç¿’æ…£ã®é”æˆå‰²åˆã®å¹³å‡ï¼‰
                    if (dayHabitCount > 0) {
                        const dayRate = Math.floor((dayTotalPct / dayHabitCount) * 100);
                        stats[dayIdx].total += dayRate;
                        stats[dayIdx].count++;
                    }
                }

                return stats.map((s, i) => ({
                    day: days[i],
                    rate: s.count > 0 ? Math.round(s.total / s.count) : 0
                }));
            }

            // 2æ—¥é€£ç¶šå¤±æ•—ã‚«ã‚¦ãƒ³ãƒˆï¼ˆ3é€£æ•— = 2å›ã‚«ã‚¦ãƒ³ãƒˆï¼‰
            function calculateConsecutiveFailures(logs, habits, startDate, endDate) {
                const results = {};

                habits.forEach(habit => {
                    const habitLogs = logs.filter(l => l.habit === habit.name);
                    const logDates = new Set(habitLogs.filter(l => {
                        const goal = getGoalAtDate(habit, l.timestamp.split('T')[0]);
                        return l.value >= goal;
                    }).map(l => l.timestamp.split('T')[0]));

                    // æœŸé–“å†…ã®å…¨æ—¥ä»˜ã‚’å–å¾—
                    const allDates = [];
                    let current = new Date(Math.max(new Date(startDate), new Date(habit.startDate || startDate)));
                    const end = new Date(endDate);
                    while (current <= end) {
                        allDates.push(formatDate(current));
                        current.setDate(current.getDate() + 1);
                    }

                    // é€£ç¶šå¤±æ•—ã‚’ã‚«ã‚¦ãƒ³ãƒˆ
                    let consecutiveFails = 0;
                    let twoDayFailCount = 0;

                    allDates.forEach(date => {
                        if (!logDates.has(date)) {
                            consecutiveFails++;
                            if (consecutiveFails >= 2) {
                                twoDayFailCount++;
                            }
                        } else {
                            consecutiveFails = 0;
                        }
                    });

                    results[habit.name] = twoDayFailCount;
                });

                return results;
            }

            // ç¿’æ…£åˆ¥Ã—æ›œæ—¥åˆ¥æˆåŠŸç‡ã‚’è¨ˆç®—
            function calculateHabitDayOfWeekStats(logs, habits, startDate, endDate) {
                const days = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
                const results = {};

                // ä»Šæ—¥ã®æ—¥ä»˜
                const today = new Date();
                today.setHours(0, 0, 0, 0);

                const startD = new Date(startDate);
                const endD = new Date(endDate);
                const actualEndD = endD > today ? today : endD;

                habits.forEach(habit => {
                    // å„æ›œæ—¥: total=é”æˆå‰²åˆã®åˆè¨ˆ, count=æ—¥æ•°
                    const habitStats = days.map(() => ({ total: 0, count: 0 }));

                    // æœŸé–“å†…ã®å…¨æ—¥ã‚’å¯¾è±¡ã«è¨ˆç®—
                    for (let d = new Date(startD); d <= actualEndD; d.setDate(d.getDate() + 1)) {
                        // ãƒ­ãƒ¼ã‚«ãƒ«æ™‚é–“ã§æ—¥ä»˜ã‚’å–å¾—
                        const year = d.getFullYear();
                        const month = String(d.getMonth() + 1).padStart(2, '0');
                        const day = String(d.getDate()).padStart(2, '0');
                        const dk = `${year}-${month}-${day}`;
                        const dayIdx = d.getDay();

                        // ç¿’æ…£ã®é–‹å§‹æ—¥ã‚ˆã‚Šå‰ã¯ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
                        if (habit.startDate && dk < habit.startDate) continue;

                        // ä¸€æ™‚åœæ­¢ä¸­ã¯ã‚«ã‚¦ãƒ³ãƒˆã—ãªã„
                        if (habit.isPaused && habit.pausedDate && dk >= habit.pausedDate) continue;

                        habitStats[dayIdx].count++;

                        // ã“ã®æ—¥ã®ãƒ­ã‚°ã‚’æ¤œç´¢
                        const log = logs.find(l => l.habit === habit.name && l.timestamp.split('T')[0] === dk);
                        if (log) {
                            const goal = getGoalAtDate(habit, dk);
                            // é”æˆå‰²åˆã‚’è¨ˆç®—ï¼ˆã‚¼ãƒ­é™¤ç®—é˜²æ­¢ï¼‰
                            const pct = goal > 0 ? Math.min(1, log.value / goal) : 0;
                            habitStats[dayIdx].total += pct * 100;
                        }
                        // ãƒ­ã‚°ãŒãªã„å ´åˆã¯0%ï¼ˆtotalã«åŠ ç®—ã—ãªã„ = 0%ã¨ã—ã¦å«ã‚ã‚‹ï¼‰
                    }

                    // æˆåŠŸç‡ã‚’è¨ˆç®—ï¼ˆé”æˆå‰²åˆã®å¹³å‡ï¼‰
                    results[habit.name] = days.map((day, i) => ({
                        day: day,
                        rate: habitStats[i].count > 0 ? Math.round(habitStats[i].total / habitStats[i].count) : 0
                    }));
                });

                return results;
            }

            // Gemini APIåˆ†æï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
            async function analyzeWithGemini(reportData, apiKey, userName) {
                const prompt = buildGeminiPrompt(reportData, userName, currentReportMonth, currentUserPlan);
                const maxRetries = 3;
                let lastError = null;

                for (let attempt = 1; attempt <= maxRetries; attempt++) {
                    try {
                        // Google AI Studio: gemini-2.5-flash ãƒ¢ãƒ‡ãƒ«ã‚’ä½¿ç”¨ï¼ˆæœ€æ–°ï¼‰
                        const modelName = 'gemini-2.5-flash';
                        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;
                        console.log('Gemini APIå‘¼ã³å‡ºã—:', modelName);

                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: prompt }] }],
                                generationConfig: {
                                    temperature: 0.7,
                                    maxOutputTokens: 8192
                                }
                            })
                        });

                        if (response.status === 429) {
                            // ãƒ¬ãƒ¼ãƒˆåˆ¶é™ã‚¨ãƒ©ãƒ¼ - å¾…æ©Ÿã—ã¦å†è©¦è¡Œ
                            const waitTime = Math.pow(2, attempt) * 2000; // 2ç§’ã€4ç§’ã€8ç§’
                            console.log(`Rate limited (429). Waiting ${waitTime / 1000}s before retry ${attempt}/${maxRetries}...`);
                            updateReportStatus(`
                            <div class="report-progress">
                                <div class="progress-step done">âœ“ ãƒ‡ãƒ¼ã‚¿æŠ½å‡ºå®Œäº†</div>
                                <div class="progress-step active">ğŸ¤– AIåˆ†æä¸­... (ãƒªãƒˆãƒ©ã‚¤ ${attempt}/${maxRetries} - ${waitTime / 1000}ç§’å¾…æ©Ÿ)</div>
                                <div class="progress-step pending">ğŸ“ˆ ã‚°ãƒ©ãƒ•ç”Ÿæˆä¸­...</div>
                                <div class="progress-step pending">ğŸ“ ãƒ¬ãƒãƒ¼ãƒˆå‡ºåŠ›ä¸­...</div>
                            </div>
                        `);
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                            continue;
                        }

                        if (!response.ok) {
                            const errorBody = await response.text();
                            throw new Error(`Gemini API error: ${response.status} - ${errorBody}`);
                        }

                        const result = await response.json();
                        const text = result.candidates?.[0]?.content?.parts?.[0]?.text || '';

                        if (!text) {
                            throw new Error('Gemini APIã‹ã‚‰ã®å¿œç­”ãŒç©ºã§ã™');
                        }

                        return parseGeminiResponse(text);

                    } catch (error) {
                        lastError = error;
                        console.error(`Attempt ${attempt} failed:`, error);

                        if (attempt < maxRetries) {
                            const waitTime = Math.pow(2, attempt) * 1000;
                            await new Promise(resolve => setTimeout(resolve, waitTime));
                        }
                    }
                }

                throw lastError || new Error('Gemini APIå‘¼ã³å‡ºã—ã«å¤±æ•—ã—ã¾ã—ãŸ');
            }

            // Geminiãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆï¼ˆæœˆåˆ¥ãƒ»ã‚³ãƒ¼ã‚¹åˆ¥å¯¾å¿œï¼‰
            function buildGeminiPrompt(reportData, userName, monthNum = null, userPlan = '3months') {
                const { startDate, endDate, habitStats, dayOfWeekStats, consecutiveFailures, weeklyData, uniqueDates } = reportData;

                // é€±æ•°ã‚’è¨ˆç®—
                const startD = new Date(startDate);
                const endD = new Date(endDate);
                const weekCount = Math.ceil((endD - startD) / (7 * 24 * 60 * 60 * 1000));

                // å¹³å‡é”æˆç‡
                const avgRate = habitStats.length > 0
                    ? Math.round(habitStats.reduce((sum, h) => sum + h.rate, 0) / habitStats.length * 10) / 10
                    : 0;

                // ç¿’æ…£åˆ¥ã®æ›œæ—¥åˆ¥æˆåŠŸç‡ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½œæˆ
                const habitDayTable = habitStats.map(h => {
                    return `${h.name}: é”æˆç‡${h.rate}%ï¼ˆ${h.achievedDays}/${h.totalDays}æ—¥ï¼‰`;
                }).join('\n');

                // ã‚³ãƒ¼ã‚¹åˆ¥ã®æœ€çµ‚æœˆã‚’å–å¾—
                const finalMonth = userPlan === '9months' ? 9 : userPlan === '6months' ? 6 : 3;
                const isFinalMonth = monthNum === finalMonth;
                const courseLabel = userPlan === '9months' ? '9ãƒ¶æœˆã‚³ãƒ¼ã‚¹' : userPlan === '6months' ? '6ãƒ¶æœˆã‚³ãƒ¼ã‚¹' : '3ãƒ¶æœˆã‚³ãƒ¼ã‚¹';

                // æœˆåˆ¥ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                let monthContext = '';
                let summaryInstruction = '';

                if (monthNum === 1) {
                    monthContext = `
ã“ã‚Œã¯${courseLabel}ã®ç¿’æ…£åŒ–é–‹å§‹ã‹ã‚‰1ãƒ¶æœˆç›®ï¼ˆ30æ—¥é–“ï¼‰ã®ãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯ã¾ã ç¿’æ…£åŒ–ã®åˆæœŸæ®µéšã«ã‚ã‚Šã€ã€Œå§‹ã‚ã‚‹ã€ã“ã¨ã®å¤§å¤‰ã•ã‚’ä¹—ã‚Šè¶ŠãˆãŸæ®µéšã§ã™ã€‚`;

                    summaryInstruction = `
${userName}ã•ã‚“ã¸ã®1ãƒ¶æœˆç›®ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®3ã¤ã®æ®µè½ã§æ§‹æˆã—ã¦ãã ã•ã„ï¼š

ã€ç¬¬1æ®µè½ã€‘ï¼ˆæŒ¨æ‹¶ã¨ç§°è³›ï¼‰
ã€Œ${userName}ã•ã‚“ã€ã¾ãšã¯1ã‹æœˆãŠç–²ã‚Œæ§˜ã§ã™ï¼ã€ã‹ã‚‰å§‹ã‚ã€
- æ±ºã‚ãŸç¿’æ…£ã‚’ã‚„ã‚Šãã‚Œã¾ã—ãŸã‹ï¼Ÿã¨ã„ã†å•ã„ã‹ã‘
- é›£ã—ã„æ—¥ã‚‚ã‚ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ãŒã€1ã‹æœˆç¶šã‘ã¦ããŸã“ã¨ã¯æœ¬å½“ã«ãˆã‚‰ã„ã¨ã„ã†ç§°è³›

ã€ç¬¬2æ®µè½ã€‘ï¼ˆå®Ÿç¸¾ã®æŒ¯ã‚Šè¿”ã‚Šï¼‰
- ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ãŸã“ã¨
- å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã›ãŸã“ã¨
- ç‰¹ã«é”æˆç‡ãŒé«˜ã„ç¿’æ…£ãŒã‚ã‚Œã°è¨€åŠ

ã€ç¬¬3æ®µè½ã€‘ï¼ˆä»Šå¾Œã¸ã®æœŸå¾…ï¼‰
- æ®‹ã‚Š${finalMonth - 1}ã‹æœˆã¸ã®æœŸå¾…
- ã€Œä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€ã¾ãŸã­ã€œâ™ªã€ã§ç· ã‚ã‚‹

è¦ªã—ã¿ã‚„ã™ãæ¸©ã‹ã„å£èª¿ã§ã€200å­—ç¨‹åº¦ã§æ›¸ã„ã¦ãã ã•ã„ã€‚ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚`;

                } else if (monthNum === 2) {
                    monthContext = `
ã“ã‚Œã¯${courseLabel}ã®ç¿’æ…£åŒ–é–‹å§‹ã‹ã‚‰2ãƒ¶æœˆç›®ã®ãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚
95%ä»¥ä¸Šã®äººãŒæŒ«æŠ˜ã™ã‚‹ä¸­ã€2ãƒ¶æœˆç¶šã‘ã¦ã„ã‚‹ã“ã¨ã¯éå¸¸ã«ç´ æ™´ã‚‰ã—ã„ã“ã¨ã§ã™ã€‚`;

                    summaryInstruction = `
${userName}ã•ã‚“ã¸ã®2ãƒ¶æœˆç›®ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®3ã¤ã®æ®µè½ã§æ§‹æˆã—ã¦ãã ã•ã„ï¼š

ã€ç¬¬1æ®µè½ã€‘ï¼ˆæŒ¨æ‹¶ã¨ç§°è³›ï¼‰
ã€Œ${userName}ã•ã‚“ã€2ã‹æœˆé–“ã€æœ¬å½“ã«ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã€ã‹ã‚‰å§‹ã‚ã€
- 2ãƒ¶æœˆç¶™ç¶šã§ãã‚‹äººã¯ä¸€æ¡ã‚Šã—ã‹ã„ãªã„ã“ã¨ï¼ˆ95%ä»¥ä¸ŠãŒæŒ«æŠ˜ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ï¼‰
- ã“ã“ã¾ã§ç¶šã‘ã¦ã“ã‚‰ã‚ŒãŸ${userName}ã•ã‚“ã¯æœ¬å½“ã«ã™ã”ã„ã¨ã„ã†ç§°è³›

ã€ç¬¬2æ®µè½ã€‘ï¼ˆå®Ÿç¸¾ã®æŒ¯ã‚Šè¿”ã‚Šï¼‰
- ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ãŸã“ã¨
- å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã›ãŸã“ã¨

ã€ç¬¬3æ®µè½ã€‘ï¼ˆä»Šå¾Œã¸ã®æœŸå¾…ï¼‰
- ã“ã®2ãƒ¶æœˆã§ä½œã‚Šå‡ºã—ãŸåœŸå°ã®ä¸Šã«ã€è‰¯ã„ç¿’æ…£ã®æ™‚é–“ã‚’æ‹¡å¤§ã—ã¦ã„ãã“ã¨
- ${isFinalMonth ? 'å’æ¥­ãŠã‚ã§ã¨ã†ã€ã“ã‚Œã‹ã‚‰ã‚‚é ‘å¼µã£ã¦ï¼' : `æ®‹ã‚Š${finalMonth - 2}ã‹æœˆã¸ã®åŠ±ã¾ã—ã¨ã€Œã‚‚ã†ä¸€è¸ã‚“å¼µã‚Šã€ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼ã€`}

è¦ªã—ã¿ã‚„ã™ãæ¸©ã‹ã„å£èª¿ã§ã€200å­—ç¨‹åº¦ã§æ›¸ã„ã¦ãã ã•ã„ã€‚ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚`;

                } else if (monthNum === 3) {
                    if (isFinalMonth) {
                        monthContext = `
ã“ã‚Œã¯${courseLabel}ã®ç¿’æ…£åŒ–é–‹å§‹ã‹ã‚‰3ãƒ¶æœˆç›®ã®ãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚
ã“ã‚ŒãŒ${courseLabel}ã®æœ€çµ‚æœˆã§ã™ï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¦‹äº‹ã«ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Œèµ°ã—ã¾ã—ãŸï¼`;

                        summaryInstruction = `
${userName}ã•ã‚“ã¸ã®3ãƒ¶æœˆç›®ï¼ˆæœ€çµ‚æœˆï¼‰ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®3ã¤ã®æ®µè½ã§æ§‹æˆã—ã¦ãã ã•ã„ï¼š

ã€ç¬¬1æ®µè½ã€‘ï¼ˆæŒ¨æ‹¶ã¨ç¥ç¦ï¼‰
ã€Œ${userName}ã•ã‚“ã€3ã‹æœˆé–“ã€æœ¬å½“ã«ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Œèµ°ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã€ã‹ã‚‰å§‹ã‚ã€
- ç¿’æ…£åŒ–ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’æœ€å¾Œã¾ã§ã‚„ã‚Šé‚ã’ãŸã“ã¨ã¸ã®å¤§ããªç¥ç¦
- å¤šãã®äººãŒé€”ä¸­ã§æŒ«æŠ˜ã™ã‚‹ä¸­ã€æœ€å¾Œã¾ã§ç¶šã‘ã‚‰ã‚ŒãŸã“ã¨ã®ç´ æ™´ã‚‰ã—ã•

ã€ç¬¬2æ®µè½ã€‘ï¼ˆå®Ÿç¸¾ã®æŒ¯ã‚Šè¿”ã‚Šï¼‰
- ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ãŸã“ã¨
- å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã›ãŸã“ã¨
- ã“ã®3ãƒ¶æœˆã§èº«ã«ã¤ã‘ãŸç¿’æ…£ãŒè²¡ç”£ã«ãªã‚‹ã“ã¨

ã€ç¬¬3æ®µè½ã€‘ï¼ˆä»Šå¾Œã¸ã®æœŸå¾…ï¼‰
- ç¿’æ…£ãŒé€”åˆ‡ã‚Œã‚‹ã“ã¨ãŒã‚ã£ã¦ã‚‚ã„ã¤ã§ã‚‚HabitBuddyã«æˆ»ã‚Œã‚‹ã“ã¨
- å’æ¥­ãŠã‚ã§ã¨ã†ã®æ°—æŒã¡ã¨ä»Šå¾Œã¸ã®æœŸå¾…

è¦ªã—ã¿ã‚„ã™ãæ¸©ã‹ã„å£èª¿ã§ã€200å­—ç¨‹åº¦ã§æ›¸ã„ã¦ãã ã•ã„ã€‚ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚`;
                    } else {
                        monthContext = `
ã“ã‚Œã¯${courseLabel}ã®ç¿’æ…£åŒ–é–‹å§‹ã‹ã‚‰3ãƒ¶æœˆç›®ã®ãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯${courseLabel}ã®${Math.round(3 / finalMonth * 100)}%ã‚’é”æˆã—ã¾ã—ãŸã€‚`;

                        summaryInstruction = `
${userName}ã•ã‚“ã¸ã®3ãƒ¶æœˆç›®ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®3ã¤ã®æ®µè½ã§æ§‹æˆã—ã¦ãã ã•ã„ï¼š

ã€ç¬¬1æ®µè½ã€‘ï¼ˆæŒ¨æ‹¶ã¨ç§°è³›ï¼‰
ã€Œ${userName}ã•ã‚“ã€3ã‹æœˆé–“ã€æœ¬å½“ã«ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã€ã‹ã‚‰å§‹ã‚ã€
- 3ãƒ¶æœˆç¶™ç¶šã§ããŸã“ã¨ã¸ã®å¤§ããªè³è³›
- ${courseLabel}ã®ç´„${Math.round(3 / finalMonth * 100)}%ã‚’é”æˆã—ãŸã“ã¨ã®ç´ æ™´ã‚‰ã—ã•

ã€ç¬¬2æ®µè½ã€‘ï¼ˆå®Ÿç¸¾ã®æŒ¯ã‚Šè¿”ã‚Šï¼‰
- ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ãŸã“ã¨
- å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã›ãŸã“ã¨

ã€ç¬¬3æ®µè½ã€‘ï¼ˆä»Šå¾Œã¸ã®æœŸå¾…ï¼‰
- æ®‹ã‚Š${finalMonth - 3}ã‹æœˆã§ç¿’æ…£ã‚’ã•ã‚‰ã«å®šç€ã•ã›ã¦ã„ãã“ã¨
- ã€Œä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€ã§ç· ã‚ã‚‹

è¦ªã—ã¿ã‚„ã™ãæ¸©ã‹ã„å£èª¿ã§ã€200å­—ç¨‹åº¦ã§æ›¸ã„ã¦ãã ã•ã„ã€‚ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚`;
                    }

                } else if (monthNum >= 4 && monthNum <= 9) {
                    if (isFinalMonth) {
                        monthContext = `
ã“ã‚Œã¯${courseLabel}ã®ç¿’æ…£åŒ–é–‹å§‹ã‹ã‚‰${monthNum}ãƒ¶æœˆç›®ã®ãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚
ã“ã‚ŒãŒ${courseLabel}ã®æœ€çµ‚æœˆã§ã™ï¼ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯è¦‹äº‹ã«${monthNum}ãƒ¶æœˆé–“ã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚’å®Œèµ°ã—ã¾ã—ãŸï¼`;

                        summaryInstruction = `
${userName}ã•ã‚“ã¸ã®${monthNum}ãƒ¶æœˆç›®ï¼ˆæœ€çµ‚æœˆï¼‰ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®3ã¤ã®æ®µè½ã§æ§‹æˆã—ã¦ãã ã•ã„ï¼š

ã€ç¬¬1æ®µè½ã€‘ï¼ˆæŒ¨æ‹¶ã¨ç¥ç¦ï¼‰
ã€Œ${userName}ã•ã‚“ã€${monthNum}ã‹æœˆé–“ã€æœ¬å½“ã«ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Œèµ°ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã€ã‹ã‚‰å§‹ã‚ã€
- ${courseLabel}ã‚’å®Œèµ°ã§ããŸã“ã¨ã¸ã®å¤§ããªç¥ç¦
- ${monthNum}ãƒ¶æœˆç¶™ç¶šã§ãã‚‹äººã¯ã»ã¨ã‚“ã©ã„ãªã„ã“ã¨ã®ç´ æ™´ã‚‰ã—ã•

ã€ç¬¬2æ®µè½ã€‘ï¼ˆå®Ÿç¸¾ã®æŒ¯ã‚Šè¿”ã‚Šï¼‰
- ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ãŸã“ã¨
- å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã›ãŸã“ã¨
- ${monthNum}ãƒ¶æœˆã§èº«ã«ã¤ã„ãŸç¿’æ…£ãŒä¸€ç”Ÿã®è²¡ç”£ã«ãªã‚‹ã“ã¨

ã€ç¬¬3æ®µè½ã€‘ï¼ˆä»Šå¾Œã¸ã®æœŸå¾…ï¼‰
- ç¿’æ…£ãŒé€”åˆ‡ã‚Œã¦ã‚‚ã„ã¤ã§ã‚‚HabitBuddyã«æˆ»ã‚Œã‚‹ã“ã¨
- å’æ¥­ãŠã‚ã§ã¨ã†ã®æ°—æŒã¡ã¨ä»Šå¾Œã¸ã®æœŸå¾…

è¦ªã—ã¿ã‚„ã™ãæ¸©ã‹ã„å£èª¿ã§ã€200å­—ç¨‹åº¦ã§æ›¸ã„ã¦ãã ã•ã„ã€‚ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚`;
                    } else {
                        monthContext = `
ã“ã‚Œã¯${courseLabel}ã®ç¿’æ…£åŒ–é–‹å§‹ã‹ã‚‰${monthNum}ãƒ¶æœˆç›®ã®ãƒ¬ãƒãƒ¼ãƒˆã§ã™ã€‚
ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¯${courseLabel}ã®${Math.round(monthNum / finalMonth * 100)}%ã‚’é”æˆã—ã¾ã—ãŸã€‚`;

                        summaryInstruction = `
${userName}ã•ã‚“ã¸ã®${monthNum}ãƒ¶æœˆç›®ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®3ã¤ã®æ®µè½ã§æ§‹æˆã—ã¦ãã ã•ã„ï¼š

ã€ç¬¬1æ®µè½ã€‘ï¼ˆæŒ¨æ‹¶ã¨ç§°è³›ï¼‰
ã€Œ${userName}ã•ã‚“ã€${monthNum}ã‹æœˆé–“ã€ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã€ã‹ã‚‰å§‹ã‚ã€
- ${monthNum}ãƒ¶æœˆã‚‚ç¶™ç¶šã—ã¦ã„ã‚‹ã“ã¨ã¸ã®ç§°è³›
- ${courseLabel}ã®${Math.round(monthNum / finalMonth * 100)}%ã‚’é”æˆã—ãŸã“ã¨ã®ç´ æ™´ã‚‰ã—ã•

ã€ç¬¬2æ®µè½ã€‘ï¼ˆå®Ÿç¸¾ã®æŒ¯ã‚Šè¿”ã‚Šï¼‰
- ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ãŸã“ã¨
- å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã›ãŸã“ã¨

ã€ç¬¬3æ®µè½ã€‘ï¼ˆä»Šå¾Œã¸ã®æœŸå¾…ï¼‰
- æ®‹ã‚Š${finalMonth - monthNum}ã‹æœˆã§ç¿’æ…£ã‚’ã•ã‚‰ã«å®šç€ã•ã›ã¦ã„ãã“ã¨
- ã€Œä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€ã§ç· ã‚ã‚‹

è¦ªã—ã¿ã‚„ã™ãæ¸©ã‹ã„å£èª¿ã§ã€200å­—ç¨‹åº¦ã§æ›¸ã„ã¦ãã ã•ã„ã€‚ãƒ•ã‚§ãƒ¼ã‚ºã®èª¬æ˜ã¯ä¸è¦ã§ã™ã€‚`;
                    }

                } else {
                    summaryInstruction = `
${userName}ã•ã‚“ã¸ã®æŒ¯ã‚Šè¿”ã‚Šãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›¸ã„ã¦ãã ã•ã„ã€‚
ä»¥ä¸‹ã®3ã¤ã®æ®µè½ã§æ§‹æˆã—ã¦ãã ã•ã„ï¼š

ã€ç¬¬1æ®µè½ã€‘ï¼ˆæŒ¨æ‹¶ã¨ç§°è³›ï¼‰
ã€Œ${userName}ã•ã‚“ã€ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ã€ã‹ã‚‰å§‹ã‚ã€
- ç¿’æ…£åŒ–ã«å–ã‚Šçµ„ã‚“ã§ããŸã“ã¨ã¸ã®ç§°è³›

ã€ç¬¬2æ®µè½ã€‘ï¼ˆå®Ÿç¸¾ã®æŒ¯ã‚Šè¿”ã‚Šï¼‰
- ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ãŸã“ã¨
- å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã›ãŸã“ã¨

ã€ç¬¬3æ®µè½ã€‘ï¼ˆä»Šå¾Œã¸ã®æœŸå¾…ï¼‰
- ä»Šå¾Œã¸ã®åŠ±ã¾ã—ã¨æœŸå¾…
- ã€Œä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€ã§ç· ã‚ã‚‹

è¦ªã—ã¿ã‚„ã™ãæ¸©ã‹ã„å£èª¿ã§ã€200å­—ç¨‹åº¦ã§æ›¸ã„ã¦ãã ã•ã„ã€‚`;
                }

                return `
ç¿’æ…£åŒ–ã‚³ãƒ¼ãƒã¨ã—ã¦${userName}ã•ã‚“ã®ãƒ‡ãƒ¼ã‚¿ã‚’åˆ†æã—ã¦ãã ã•ã„ã€‚

ã€æ³¨æ„ã€‘ã“ã®ã‚¢ãƒ—ãƒªã«ã¯ãƒªãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ»é€šçŸ¥ãƒ»å‹é”æ©Ÿèƒ½ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¢ãƒ—ãƒªå¤–ã®æ–¹æ³•ã§ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã—ã¦ãã ã•ã„ã€‚

${monthContext}

ã€æœŸé–“ã€‘${startDate}ã€œ${endDate}ï¼ˆ${weekCount}é€±é–“ï¼‰

ã€ãƒ‡ãƒ¼ã‚¿ã€‘
- è¨˜éŒ²æ—¥æ•°: ${uniqueDates.length}æ—¥ã€é”æˆç‡: ${avgRate}%
- ç¿’æ…£åˆ¥: ${habitDayTable}
- æ›œæ—¥åˆ¥: ${dayOfWeekStats.map(d => `${d.day}:${d.rate}%`).join(', ')}
- 2æ—¥é€£ç¶šå¤±æ•—: ${Object.entries(consecutiveFailures).map(([n, c]) => `${n}:${c}å›`).join(', ')}

ä»¥ä¸‹ã®å½¢å¼ã§å›ç­”ã—ã¦ãã ã•ã„ï¼š

## ç·è«–
${summaryInstruction}

## å¾—æ„ãªç‚¹
ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãå¼·ã¿ã‚’3ç‚¹ã€å„30å­—ç¨‹åº¦ã§ã€‚å¿…ãšå…·ä½“çš„ãªæ•°å€¤ï¼ˆâ—¯%ã€â—¯æ—¥ãªã©ï¼‰ã‚’å«ã‚ã¦ãã ã•ã„ã€‚

## è‹¦æ‰‹ãªç‚¹
æ”¹å–„ç‚¹ã‚’3ç‚¹ã€å„30å­—ç¨‹åº¦ã§ã€‚å¿…ãšå…·ä½“çš„ãªæ•°å€¤ï¼ˆâ—¯%ã€â—¯å›ãªã©ï¼‰ã‚’å«ã‚ã¦ãã ã•ã„ã€‚

## å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹
å®Ÿè·µçš„ãªã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’3ç‚¹ã€å„50å­—ç¨‹åº¦ã§ã€‚
`;
            }

            // Geminiå¿œç­”ã®ãƒ‘ãƒ¼ã‚¹
            function parseGeminiResponse(text) {
                console.log('Geminiå¿œç­”ã‚’ãƒ‘ãƒ¼ã‚¹:', text);

                const sections = {
                    summary: '',
                    strengths: '',
                    improvements: '',
                    advice: ''
                };

                // ç·è«–ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆè¤‡æ•°ãƒ‘ã‚¿ãƒ¼ãƒ³ã«å¯¾å¿œï¼‰
                // AIãŒã€Œ## ç·è«–ã€è¦‹å‡ºã—ã‚’ä½¿ã‚ãªã„å ´åˆã€æœ€åˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆ## å¾—æ„ã®å‰ï¼‰ã‚’ç·è«–ã¨ã—ã¦å–å¾—
                const summaryMatch = text.match(/## ç·è«–[^\n]*\n([\s\S]*?)(?=##|$)/) ||
                    text.match(/ç·è«–[ï¼š:]\s*([\s\S]*?)(?=##|å¾—æ„|$)/) ||
                    text.match(/^([\s\S]*?)(?=## å¾—æ„|### ğŸ’ª|## è‹¦æ‰‹|$)/); // æœ€åˆã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’å–å¾—

                // å¾—æ„ãªç‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
                const strengthsMatch = text.match(/## å¾—æ„[^\n]*\n([\s\S]*?)(?=## è‹¦æ‰‹|## æ”¹å–„|## å…·ä½“çš„|$)/) ||
                    text.match(/### ğŸ’ª å¾—æ„[^\n]*\n([\s\S]*?)(?=### â—‡|## å…·ä½“çš„|$)/) ||
                    text.match(/å¾—æ„[^\n]*[ï¼š:]\s*([\s\S]*?)(?=è‹¦æ‰‹|æ”¹å–„|å…·ä½“çš„|$)/);

                // è‹¦æ‰‹ãªç‚¹/æ”¹å–„ç‚¹ã‚’ãƒ‘ãƒ¼ã‚¹
                const improvementsMatch = text.match(/## è‹¦æ‰‹[^\n]*\n([\s\S]*?)(?=## å…·ä½“çš„|$)/) ||
                    text.match(/### â—‡ è‹¦æ‰‹[^\n]*\n([\s\S]*?)(?=## å…·ä½“çš„|## ğŸ’¡|$)/) ||
                    text.match(/## æ”¹å–„[^\n]*\n([\s\S]*?)(?=## å…·ä½“çš„|$)/) ||
                    text.match(/è‹¦æ‰‹[^\n]*[ï¼š:]\s*([\s\S]*?)(?=å…·ä½“çš„|ã‚¢ãƒ‰ãƒã‚¤ã‚¹|$)/);

                // å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ãƒ‘ãƒ¼ã‚¹ï¼ˆã‚ˆã‚ŠæŸ”è»Ÿãªãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
                const adviceMatch = text.match(/## å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹[^\n]*\n([\s\S]*?)$/) ||
                    text.match(/## ğŸ’¡ å…·ä½“çš„[^\n]*\n([\s\S]*?)$/) ||
                    text.match(/## å…·ä½“çš„[^\n]*\n([\s\S]*?)$/) ||
                    text.match(/å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹[^\n]*[ï¼š:]\s*([\s\S]*?)$/) ||
                    text.match(/ã‚¢ãƒ‰ãƒã‚¤ã‚¹[^\n]*[ï¼š:]\s*([\s\S]*?)$/);

                if (summaryMatch) sections.summary = summaryMatch[1].trim();
                if (strengthsMatch) sections.strengths = strengthsMatch[1].trim();
                if (improvementsMatch) sections.improvements = improvementsMatch[1].trim();
                if (adviceMatch) sections.advice = adviceMatch[1].trim();

                // ãƒ‘ãƒ¼ã‚¹çµæœã‚’ãƒ­ã‚°
                console.log('ãƒ‘ãƒ¼ã‚¹çµæœ:', sections);

                // ä½•ã‚‚å–å¾—ã§ããªã‹ã£ãŸå ´åˆã¯å…¨æ–‡ã‚’ç·è«–ã¨ã—ã¦ä½¿ç”¨
                if (!sections.summary && !sections.strengths && !sections.improvements && !sections.advice) {
                    sections.summary = text.trim();
                }

                return sections;
            }

            // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆåˆ†æç”Ÿæˆï¼ˆAIåˆ†æã‚¹ã‚­ãƒƒãƒ—æ™‚ï¼‰- æœˆåˆ¥å¯¾å¿œ
            function generateDefaultAnalysis(reportData, userName, monthNum = null, userPlan = '3months') {
                const { habitStats, dayOfWeekStats, uniqueDates, logs, consecutiveFailures, startDate, endDate } = reportData;

                // é€±æ•°ã‚’è¨ˆç®—
                const startD = new Date(startDate);
                const endD = new Date(endDate);
                const weekCount = Math.ceil((endD - startD) / (7 * 24 * 60 * 60 * 1000));

                // æœ€ã‚‚é”æˆç‡ãŒé«˜ã„ç¿’æ…£
                const topHabit = habitStats.length > 0
                    ? habitStats.reduce((a, b) => a.rate > b.rate ? a : b)
                    : null;

                // æœ€ã‚‚é”æˆç‡ãŒä½ã„ç¿’æ…£
                const worstHabit = habitStats.length > 0
                    ? habitStats.reduce((a, b) => a.rate < b.rate ? a : b)
                    : null;

                // æœ€ã‚‚é”æˆç‡ãŒé«˜ã„æ›œæ—¥
                const bestDay = dayOfWeekStats.reduce((a, b) => a.rate > b.rate ? a : b);

                // æœ€ã‚‚é”æˆç‡ãŒä½ã„æ›œæ—¥
                const worstDay = dayOfWeekStats.reduce((a, b) => a.rate < b.rate ? a : b);

                // å¹³å‡é”æˆç‡
                const avgRate = habitStats.length > 0
                    ? Math.round(habitStats.reduce((sum, h) => sum + h.rate, 0) / habitStats.length)
                    : 0;

                // 2æ—¥é€£ç¶šå¤±æ•—ãŒæœ€ã‚‚å¤šã„ç¿’æ…£
                const worstConsecutive = Object.entries(consecutiveFailures || {})
                    .sort((a, b) => b[1] - a[1])[0];

                // 2ç•ªç›®ã«è‰¯ã„ç¿’æ…£
                const sortedHabits = [...habitStats].sort((a, b) => b.rate - a.rate);
                const secondBestHabit = sortedHabits[1] || null;

                // 2ç•ªç›®ã«è‰¯ã„æ›œæ—¥
                const sortedDays = [...dayOfWeekStats].sort((a, b) => b.rate - a.rate);
                const secondBestDay = sortedDays[1] || null;

                // ã‚³ãƒ¼ã‚¹åˆ¥ã®æœ€çµ‚æœˆã‚’å–å¾—
                const finalMonth = userPlan === '9months' ? 9 : userPlan === '6months' ? 6 : 3;
                const isFinalMonth = monthNum === finalMonth;
                const remainingMonths = finalMonth - monthNum;

                // æœˆåˆ¥ã®ã‚µãƒãƒªãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
                let summaryMessage;

                if (monthNum === 1) {
                    summaryMessage = `${userName}ã•ã‚“ã€ã¾ãšã¯1ã‹æœˆãŠç–²ã‚Œæ§˜ã§ã™ï¼

æ±ºã‚ãŸç¿’æ…£ã‚’ã‚„ã‚Šãã‚Œã¾ã—ãŸã‹ï¼Ÿé›£ã—ã„æ—¥ã‚‚ã‚ã£ãŸã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€1ã‹æœˆç¶šã‘ã¦ããŸã“ã¨ã¯æœ¬å½“ã«ãˆã‚‰ã„ã§ã™ã€‚

ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ã€å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã•ã‚Œã¾ã—ãŸã€‚${topHabit ? `ç‰¹ã«ã€Œ${topHabit.name}ã€ã¯é”æˆç‡${topHabit.rate}%ã¨ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ã€‚` : ''}

ã§ã¯æ®‹ã‚Š${remainingMonths}ã‹æœˆã€ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€ã¾ãŸã­ã€œâ™ª`;

                } else if (monthNum === 2) {
                    const closingMessage = isFinalMonth
                        ? `ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Œèµ°ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã“ã‚Œã‹ã‚‰ã‚‚é ‘å¼µã£ã¦ãã ã•ã„ï¼`
                        : `ã“ã®2ãƒ¶æœˆã§ä½œã‚Šå‡ºã—ãŸåœŸå°ã®ä¸Šã«ã€ç€å®Ÿã«è‰¯ã„ç¿’æ…£ã®æ™‚é–“ã‚’æ‹¡å¤§ã—ã¦ã„ãã¾ã™ã€‚æ®‹ã‚Š${remainingMonths}ã‹æœˆã€ã‚‚ã†ä¸€è¸ã‚“å¼µã‚Šã€ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼`;

                    summaryMessage = `${userName}ã•ã‚“ã€2ã‹æœˆé–“ã€æœ¬å½“ã«ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼

ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼ä½•ã‹ã‚’å§‹ã‚ã¦2ã‹æœˆé–“ã‚‚ç¶™ç¶šã§ãã‚‹äººã¯ã€å®Ÿã¯ã»ã‚“ã®ä¸€æ¡ã‚Šã—ã‹ã„ã¾ã›ã‚“ã€‚å®Ÿéš›ã€95%ä»¥ä¸Šã®äººãŒæŒ«æŠ˜ã—ã¦ã—ã¾ã†ã¨è¨€ã‚ã‚Œã¦ã„ã¾ã™ã€‚ãã‚“ãªä¸­ã§ã“ã“ã¾ã§ç¶šã‘ã¦ã“ã‚‰ã‚ŒãŸ${userName}ã•ã‚“ã¯ã€æœ¬å½“ã«ã™ã”ã„ã§ã™ã€‚

ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ã€å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã•ã‚Œã¾ã—ãŸã€‚${topHabit ? `ç‰¹ã«ã€Œ${topHabit.name}ã€ã¯é”æˆç‡${topHabit.rate}%ã¨ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ã€‚` : ''}

${closingMessage}`;

                } else if (monthNum === 3) {
                    if (isFinalMonth) {
                        // 3ãƒ¶æœˆã‚³ãƒ¼ã‚¹ã®æœ€çµ‚æœˆï¼ˆå’æ¥­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
                        summaryMessage = `${userName}ã•ã‚“ã€3ã‹æœˆé–“ã€æœ¬å½“ã«ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Œèµ°ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰

ä½•ã‹ã‚’å§‹ã‚ã¦3ã‹æœˆé–“ã‚‚ç¶™ç¶šã§ãã‚‹äººã¯ã€å®Ÿã¯ã»ã‚“ã®ä¸€æ¡ã‚Šã—ã‹ã„ã¾ã›ã‚“ã€‚ã“ã“ã¾ã§ç¶šã‘ã¦ã“ã‚‰ã‚ŒãŸ${userName}ã•ã‚“ã¯ã€æœ¬å½“ã«ã™ã”ã„ã§ã™ã€‚

ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ã€å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã•ã‚Œã¾ã—ãŸã€‚${topHabit ? `ç‰¹ã«ã€Œ${topHabit.name}ã€ã¯é”æˆç‡${topHabit.rate}%ã¨ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ã€‚` : ''}

ã“ã‚Œã‹ã‚‰ã‚‚ç¿’æ…£ãŒé€”åˆ‡ã‚Œã‚‹ã“ã¨ãŒã‚ã£ã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã„ã¤ã§ã‚‚HabitBuddyã«æˆ»ã£ã¦ãã¦ãã ã•ã„ã€‚${userName}ã•ã‚“ã®ã“ã‚Œã‹ã‚‰ã‚’å¿œæ´ã—ã¦ã„ã¾ã™ï¼`;
                    } else {
                        // 6ãƒ¶æœˆ/9ãƒ¶æœˆã‚³ãƒ¼ã‚¹ã®3ãƒ¶æœˆç›®ï¼ˆã¾ã é€”ä¸­ï¼‰
                        summaryMessage = `${userName}ã•ã‚“ã€3ã‹æœˆé–“ã€æœ¬å½“ã«ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼

3ãƒ¶æœˆç¶™ç¶šã¯å¤§ããªç¯€ç›®ã§ã™ï¼ã“ã“ã¾ã§ç¶šã‘ã¦ã“ã‚‰ã‚ŒãŸ${userName}ã•ã‚“ã¯æœ¬å½“ã«ç´ æ™´ã‚‰ã—ã„ã§ã™ã€‚

ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ã€å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã•ã‚Œã¾ã—ãŸã€‚${topHabit ? `ç‰¹ã«ã€Œ${topHabit.name}ã€ã¯é”æˆç‡${topHabit.rate}%ã¨ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ã€‚` : ''}

æ®‹ã‚Š${remainingMonths}ã‹æœˆã€ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼`;
                    }

                } else if (monthNum >= 4 && monthNum <= 9) {
                    if (isFinalMonth) {
                        // æœ€çµ‚æœˆï¼ˆå’æ¥­ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼‰
                        summaryMessage = `${userName}ã•ã‚“ã€${monthNum}ã‹æœˆé–“ã€æœ¬å½“ã«ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼ãƒ—ãƒ­ã‚°ãƒ©ãƒ å®Œèµ°ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ğŸ‰

${monthNum}ãƒ¶æœˆã¨ã„ã†é•·ã„æœŸé–“ã‚’ç¶™ç¶šã§ãã‚‹äººã¯éå¸¸ã«å°‘ãªãã€${userName}ã•ã‚“ã¯æœ¬å½“ã«ã™ã”ã„ã§ã™ã€‚

ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ã€å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã•ã‚Œã¾ã—ãŸã€‚${topHabit ? `ç‰¹ã«ã€Œ${topHabit.name}ã€ã¯é”æˆç‡${topHabit.rate}%ã¨ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ã€‚` : ''}

ã“ã‚Œã‹ã‚‰ã‚‚ç¿’æ…£ãŒé€”åˆ‡ã‚Œã‚‹ã“ã¨ãŒã‚ã£ã¦ã‚‚å¤§ä¸ˆå¤«ã€‚ã„ã¤ã§ã‚‚HabitBuddyã«æˆ»ã£ã¦ãã¦ãã ã•ã„ã€‚${userName}ã•ã‚“ã®ã“ã‚Œã‹ã‚‰ã‚’å¿œæ´ã—ã¦ã„ã¾ã™ï¼`;
                    } else {
                        // ã¾ã æœ€çµ‚æœˆã§ã¯ãªã„
                        const closingPhrase = remainingMonths <= 2 ? 'ã‚´ãƒ¼ãƒ«ã¯ã‚‚ã†ã™ãã§ã™ï¼' : '';
                        summaryMessage = `${userName}ã•ã‚“ã€${monthNum}ã‹æœˆé–“ã€æœ¬å½“ã«ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼

${monthNum}ãƒ¶æœˆã‚‚ç¶™ç¶šã§ãã¦ã„ã‚‹${userName}ã•ã‚“ã¯ã€æœ¬å½“ã«ã™ã”ã„ã§ã™ã€‚

ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ã€å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã•ã‚Œã¾ã—ãŸã€‚${topHabit ? `ç‰¹ã«ã€Œ${topHabit.name}ã€ã¯é”æˆç‡${topHabit.rate}%ã¨ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ã€‚` : ''}

æ®‹ã‚Š${remainingMonths}ã‹æœˆã€${closingPhrase}ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼`;
                    }

                } else {
                    summaryMessage = `${userName}ã•ã‚“ã€${weekCount}é€±é–“ãŠç–²ã‚Œæ§˜ã§ã™ï¼

ã“ã®æœŸé–“ã«${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’æ®‹ã—ã€å¹³å‡é”æˆç‡${avgRate}%ã¨ã„ã†çµæœã‚’å‡ºã•ã‚Œã¾ã—ãŸã€‚${topHabit ? `ç‰¹ã«ã€Œ${topHabit.name}ã€ã¯é”æˆç‡${topHabit.rate}%ã¨ç´ æ™´ã‚‰ã—ã„çµæœã§ã™ã€‚` : ''}

ä¸€ç·’ã«é ‘å¼µã‚Šã¾ã—ã‚‡ã†ï¼`;
                }

                return {
                    summary: summaryMessage,

                    strengths: `- **${bestDay.day}æ›œæ—¥ã®æˆåŠŸç‡ãŒ${bestDay.rate}%ã¨æœ€ã‚‚é«˜ã„**ï¼šã“ã®æ›œæ—¥ã«ç¿’æ…£ã‚’å®Ÿè¡Œã—ã‚„ã™ã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚ä»•äº‹ã‚„ç”Ÿæ´»ã®ãƒªã‚ºãƒ ãŒã“ã®æ›œæ—¥ã«åˆã£ã¦ã„ã‚‹ã®ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“
- **${secondBestDay ? `${secondBestDay.day}æ›œæ—¥ã‚‚${secondBestDay.rate}%ã¨å¥½èª¿` : 'è¤‡æ•°ã®æ›œæ—¥ã§å®‰å®šã—ãŸæˆç¸¾'}**ï¼šé€±ã®ä¸­ã§è¤‡æ•°ã®å¾—æ„ãªæ—¥ãŒã‚ã‚‹ã“ã¨ã¯å¤§ããªå¼·ã¿ã§ã™
- **${topHabit ? `ã€Œ${topHabit.name}ã€ã¯é”æˆç‡${topHabit.rate}%ã§æœ€ã‚‚é«˜ã„` : 'ç¶™ç¶šçš„ã«è¨˜éŒ²ã—ã¦ã„ã‚‹'}**ï¼š${topHabit ? 'ã“ã®ç¿’æ…£ã¯ã™ã§ã«ç”Ÿæ´»ã®ä¸€éƒ¨ã¨ã—ã¦å®šç€ã—ã¤ã¤ã‚ã‚Šã¾ã™ã€‚ã“ã®æˆåŠŸãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ä»–ã®ç¿’æ…£ã«ã‚‚å¿œç”¨ã§ãã¾ã™' : 'è¨˜éŒ²ã‚’ç¶šã‘ã‚‹ã“ã¨ã§ç¿’æ…£åŒ–ãŒç€å®Ÿã«é€²ã‚“ã§ã„ã¾ã™'}
- **${secondBestHabit ? `ã€Œ${secondBestHabit.name}ã€ã‚‚é”æˆç‡${secondBestHabit.rate}%ã¨å®‰å®š` : 'è¤‡æ•°ã®ç¿’æ…£ã‚’åŒæ™‚ã«ç®¡ç†'}**ï¼š${secondBestHabit ? 'è¤‡æ•°ã®ç¿’æ…£ã‚’é«˜ã„æ°´æº–ã§ç¶­æŒã§ãã¦ã„ã‚‹ç‚¹ã¯ç´ æ™´ã‚‰ã—ã„ã§ã™' : 'è¤‡æ•°ã®ç¿’æ…£ã‚’åŒæ™‚ã«ç®¡ç†ã™ã‚‹åŠ›ãŒèº«ã«ã¤ã„ã¦ã„ã¾ã™'}
- **${uniqueDates.length}æ—¥é–“ã®è¨˜éŒ²ã‚’ç¶™ç¶š**ï¼šæ¯æ—¥è¨˜éŒ²ã‚’ã¤ã‘ã‚‹ã“ã¨è‡ªä½“ãŒå¤§ããªç¿’æ…£ã§ã™ã€‚ã“ã®ç¶™ç¶šåŠ›ã¯ä»–ã®ç›®æ¨™é”æˆã«ã‚‚æ´»ã‹ã›ã¾ã™
- **${logs.length}ä»¶ã®ç·è¨˜éŒ²æ•°**ï¼šã“ã‚Œã ã‘ã®è¨˜éŒ²ã‚’ç©ã¿é‡ã­ã¦ããŸåŠªåŠ›ã¯ç¢ºå®Ÿã«ã‚ãªãŸã®è²¡ç”£ã«ãªã£ã¦ã„ã¾ã™`,

                    improvements: `- **${worstDay.day}æ›œæ—¥ã®æˆåŠŸç‡ãŒ${worstDay.rate}%ã¨æœ€ã‚‚ä½ã„**ï¼šã“ã®æ›œæ—¥ã«ç¿’æ…£ãŒé€”åˆ‡ã‚Œã‚„ã™ã„å‚¾å‘ãŒã‚ã‚Šã¾ã™ã€‚ã“ã®æ›œæ—¥ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚„ä½“èª¿ã‚’è¦‹ç›´ã—ã¦ã¿ã¾ã—ã‚‡ã†
- **${worstHabit ? `ã€Œ${worstHabit.name}ã€ã¯é”æˆç‡${worstHabit.rate}%ã¨æœ€ã‚‚ä½ã„` : 'ä¸€éƒ¨ã®ç¿’æ…£ãŒå®šç€ã—ã¦ã„ãªã„'}**ï¼š${worstHabit ? 'ã“ã®ç¿’æ…£ã¯ç¾åœ¨ã®è¨­å®šã ã¨ãƒãƒ¼ãƒ‰ãƒ«ãŒé«˜ã™ãã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚ç›®æ¨™ã‚’åŠåˆ†ã«ä¸‹ã’ã¦ã¿ã‚‹ã“ã¨ã‚’æ¤œè¨ã—ã¦ãã ã•ã„' : 'ç¿’æ…£ã®é›£æ˜“åº¦ã‚’å…¨ä½“çš„ã«è¦‹ç›´ã™ã“ã¨ã§æ”¹å–„ãŒæœŸå¾…ã§ãã¾ã™'}
- **${worstConsecutive ? `ã€Œ${worstConsecutive[0]}ã€ã¯2æ—¥é€£ç¶šå¤±æ•—ãŒ${worstConsecutive[1]}å›` : 'é€£ç¶šå¤±æ•—ã®ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒã‚ã‚‹'}**ï¼š2æ—¥é€£ç¶šã§å¤±æ•—ã™ã‚‹ã¨ç¿’æ…£ãŒé€”åˆ‡ã‚Œã‚„ã™ããªã‚Šã¾ã™ã€‚1æ—¥å¤±æ•—ã—ã¦ã‚‚ç¿Œæ—¥ã¯å¿…ãšå®Ÿè¡Œã™ã‚‹æ„è­˜ã‚’æŒã¡ã¾ã—ã‚‡ã†
- **ç¿’æ…£å®Ÿè¡Œç‡ãŒ${avgRate}%**ï¼šã¾ã å®šç€ã«è‡³ã£ã¦ã„ãªã„ç¿’æ…£ãŒã‚ã‚Šã¾ã™ã€‚ç¿’æ…£ã®æ•°ã‚’æ¸›ã‚‰ã—ã¦è³ªã‚’é«˜ã‚ã‚‹ã“ã¨ã‚‚é¸æŠè‚¢ã®ä¸€ã¤ã§ã™
- **æ›œæ—¥ã«ã‚ˆã‚‹ã°ã‚‰ã¤ããŒã‚ã‚‹**ï¼šå®‰å®šã—ãŸç¿’æ…£åŒ–ã®ãŸã‚ã«ã¯ã€æ›œæ—¥ã«é–¢ä¿‚ãªãå®Ÿè¡Œã§ãã‚‹ä»•çµ„ã¿ã¥ãã‚ŠãŒé‡è¦ã§ã™
- **è‹¦æ‰‹ãªç¿’æ…£ã«æ™‚é–“ã‚’å–ã‚‰ã‚Œã™ãã¦ã„ã‚‹å¯èƒ½æ€§**ï¼šå¾—æ„ãªç¿’æ…£ã‚’å„ªå…ˆã—ã€è‹¦æ‰‹ãªç¿’æ…£ã¯æœ€å°é™ã‹ã‚‰å§‹ã‚ã‚‹ã“ã¨ã§å…¨ä½“ã®æˆåŠŸç‡ãŒä¸ŠãŒã‚Šã¾ã™`,

                    advice: `- **è‹¦æ‰‹ãªç¿’æ…£ã®ç›®æ¨™ã‚’æ€ã„åˆ‡ã£ã¦ä¸‹ã’ã‚‹**ï¼šã€Œ5åˆ†ã ã‘ã‚„ã‚‹ã€ã€Œ1ãƒšãƒ¼ã‚¸ã ã‘èª­ã‚€ã€ã€Œ1å•ã ã‘è§£ãã€ãªã©ã€ãƒãƒ¼ãƒ‰ãƒ«ã‚’æ¥µé™ã¾ã§ä¸‹ã’ã¦æˆåŠŸä½“é¨“ã‚’å¢—ã‚„ã—ã¾ã—ã‚‡ã†ã€‚å°ã•ãªæˆåŠŸãŒè‡ªä¿¡ã¨ãªã‚Šã€å¾ã€…ã«é‡ã‚’å¢—ã‚„ã›ã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™

- **å¾—æ„ãª${bestDay.day}æ›œæ—¥ã‚’æ´»ç”¨ã™ã‚‹**ï¼š${bestDay.day}æ›œæ—¥ã¯ç¿’æ…£ãŒç¶šãã‚„ã™ã„æ—¥ã§ã™ã€‚ã“ã®æ—¥ã«å¹³æ—¥ã®é…ã‚Œã‚’å–ã‚Šæˆ»ã—ãŸã‚Šã€æ¥é€±ã®æº–å‚™ã‚’ã—ãŸã‚Šã™ã‚‹æ™‚é–“ã¨ã—ã¦æ´»ç”¨ã—ã¦ã¿ã¾ã—ã‚‡ã†

- **ç¿’æ…£ã®çµ„ã¿åˆã‚ã›ï¼ˆãƒãƒ“ãƒƒãƒˆã‚¹ã‚¿ãƒƒã‚­ãƒ³ã‚°ï¼‰ã‚’è©¦ã™**ï¼š${topHabit ? `å¾—æ„ãªã€Œ${topHabit.name}ã€ã®ç›´å¾Œã«è‹¦æ‰‹ãªç¿’æ…£ã‚’å®Ÿè¡Œã™ã‚‹` : 'å®šç€ã—ã¦ã„ã‚‹ç¿’æ…£ã®å¾Œã«æ–°ã—ã„ç¿’æ…£ã‚’è¿½åŠ ã™ã‚‹'}ã“ã¨ã§ã€æ—¢å­˜ã®ç¿’æ…£ã®åŠ›ã‚’å€Ÿã‚Šã¦æ–°ã—ã„ç¿’æ…£ã‚’å®šç€ã•ã›ã‚„ã™ããªã‚Šã¾ã™

- **${worstDay.day}æ›œæ—¥ã®éã”ã—æ–¹ã‚’è¦‹ç›´ã™**ï¼šè‹¦æ‰‹ãªæ›œæ—¥ã«ã¯ç‰¹åˆ¥ãªãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚’è¨­å®šã—ã¾ã—ã‚‡ã†ã€‚å‰æ—¥ã®å¤œã«æº–å‚™ã‚’æ¸ˆã¾ã›ã¦ãŠãã€æœä¸€ç•ªã«å–ã‚Šçµ„ã‚€ã€ãªã©ã®å·¥å¤«ãŒåŠ¹æœçš„ã§ã™

- **é€±1å›ã®æŒ¯ã‚Šè¿”ã‚Šã‚¿ã‚¤ãƒ ã‚’è¨­ã‘ã‚‹**ï¼šæ¯é€±æ—¥æ›œæ—¥ãªã©ã«5åˆ†é–“ã€å…ˆé€±ã®è¨˜éŒ²ã‚’æŒ¯ã‚Šè¿”ã‚‹æ™‚é–“ã‚’ä½œã‚Šã¾ã—ã‚‡ã†ã€‚ä½•ãŒã†ã¾ãã„ã£ã¦ä½•ãŒé›£ã—ã‹ã£ãŸã‹ã‚’æŠŠæ¡ã™ã‚‹ã“ã¨ã§ã€æ¬¡é€±ã®æ”¹å–„ã«ã¤ãªã’ã‚‰ã‚Œã¾ã™`
                };
            }

            // ã‚°ãƒ©ãƒ•ç”»åƒç”Ÿæˆï¼ˆã‚·ãƒ³ãƒ—ãƒ«ãƒ‡ã‚¶ã‚¤ãƒ³ï¼‰
            async function generateChartImages(reportData) {
                // ã‚°ãƒ©ãƒ•ç”Ÿæˆç”¨ã®éš ã‚ŒãŸã‚³ãƒ³ãƒ†ãƒŠã‚’ä½œæˆ
                const container = document.createElement('div');
                container.id = 'chartGenContainer';
                container.style.cssText = 'position:fixed; top:-9999px; left:-9999px; width:600px; background:white; padding:30px 24px; border-radius:16px;';
                document.body.appendChild(container);

                const images = {};

                // çµ±ä¸€ã‚«ãƒ©ãƒ¼ï¼ˆæ›œæ—¥åˆ¥ç”¨ï¼‰
                const mainColor = '#0891B2';

                // ç¿’æ…£åˆ¥ã®ã‚«ãƒ©ãƒ¼ï¼ˆå€‹äººè¨­å®šã‚’ä½¿ç”¨ï¼‰
                const habitColors = reportData.habitStats.map(h => h.color || '#0891B2');

                try {
                    // æ›œæ—¥åˆ¥é”æˆç‡ã‚°ãƒ©ãƒ•ï¼ˆç¸¦æ£’ã‚°ãƒ©ãƒ•ï¼‰
                    images.weekday = await renderAndCaptureChart(container, 'weekdayExport', {
                        type: 'bar',
                        data: {
                            labels: reportData.dayOfWeekStats.map(d => d.day),
                            datasets: [{
                                data: reportData.dayOfWeekStats.map(d => d.rate),
                                backgroundColor: mainColor,
                                borderRadius: 6,
                                borderSkipped: false,
                                barPercentage: 0.7
                            }]
                        },
                        options: {
                            responsive: false,
                            maintainAspectRatio: false,
                            layout: {
                                padding: { top: 25 }
                            },
                            plugins: {
                                legend: { display: false },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    offset: 2,
                                    formatter: (value) => value + '%',
                                    font: { weight: 'bold', size: 12 },
                                    color: '#1F2937'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    min: 0,
                                    max: 100,
                                    ticks: {
                                        callback: v => v + '%',
                                        stepSize: 20,
                                        font: { size: 11 }
                                    },
                                    grid: { color: 'rgba(0,0,0,0.08)' },
                                    border: { display: true }
                                },
                                x: {
                                    ticks: { font: { size: 13, weight: '600' } },
                                    grid: { display: false }
                                }
                            }
                        }
                    }, 'æ›œæ—¥åˆ¥é”æˆç‡');

                    // ç¿’æ…£åˆ¥é”æˆç‡ã‚°ãƒ©ãƒ•ï¼ˆç¸¦æ£’ã‚°ãƒ©ãƒ•ãƒ»å€‹äººè¨­å®šã‚«ãƒ©ãƒ¼ä½¿ç”¨ï¼‰
                    // ãƒ©ãƒ™ãƒ«ã«ä¸€æ™‚åœæ­¢ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’è¿½åŠ 
                    const habitLabels = reportData.habitStats.map(h => {
                        if (h.pauseStatus === 'paused_before') {
                            return h.name + '\n(åœæ­¢ä¸­)';
                        } else if (h.pauseStatus === 'paused_during') {
                            return h.name + '\n(ä¸€æ™‚åœæ­¢)';
                        }
                        return h.name;
                    });

                    images.habit = await renderAndCaptureChart(container, 'habitExport', {
                        type: 'bar',
                        data: {
                            labels: habitLabels,
                            datasets: [{
                                data: reportData.habitStats.map(h => h.rate),
                                backgroundColor: habitColors,
                                borderRadius: 6,
                                borderSkipped: false,
                                barPercentage: 0.7
                            }]
                        },
                        options: {
                            responsive: false,
                            maintainAspectRatio: false,
                            layout: {
                                padding: { top: 25 }
                            },
                            plugins: {
                                legend: { display: false },
                                datalabels: {
                                    anchor: 'end',
                                    align: 'top',
                                    offset: 2,
                                    formatter: (value) => value + '%',
                                    font: { weight: 'bold', size: 12 },
                                    color: '#1F2937'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    min: 0,
                                    max: 100,
                                    ticks: {
                                        callback: v => v + '%',
                                        stepSize: 20,
                                        font: { size: 11 }
                                    },
                                    grid: { color: 'rgba(0,0,0,0.08)' },
                                    border: { display: true }
                                },
                                x: {
                                    ticks: { font: { size: 13, weight: '600' } },
                                    grid: { display: false }
                                }
                            }
                        }
                    }, 'ç¿’æ…£åˆ¥é”æˆç‡');

                } finally {
                    container.remove();
                }

                return images;
            }

            async function renderAndCaptureChart(container, canvasId, chartConfig, title) {
                // datalabelsãƒ—ãƒ©ã‚°ã‚¤ãƒ³ã‚’ç™»éŒ²
                if (typeof ChartDataLabels !== 'undefined') {
                    Chart.register(ChartDataLabels);
                }

                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ç„¡åŠ¹åŒ–ï¼ˆã‚­ãƒ£ãƒ—ãƒãƒ£æ™‚ã«ãƒãƒ¼ãŒè¡¨ç¤ºã•ã‚Œãªã„å•é¡Œã‚’ä¿®æ­£ï¼‰
                if (!chartConfig.options) chartConfig.options = {};
                chartConfig.options.animation = false;

                // ã‚¿ã‚¤ãƒˆãƒ«ã¨ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ä½œæˆï¼ˆãƒ‡ã‚¶ã‚¤ãƒ³æ”¹å–„ + èƒŒæ™¯è‰²è¿½åŠ ï¼‰
                container.style.backgroundColor = '#f0f4f8';
                container.style.padding = '20px';
                container.style.borderRadius = '16px';
                container.innerHTML = `
                <div style="font-size:18px; font-weight:800; margin-bottom:16px; color:#1F2937; text-align:center;">${title}</div>
                <canvas id="${canvasId}" width="550" height="300"></canvas>
            `;

                const canvas = document.getElementById(canvasId);
                const ctx = canvas.getContext('2d');

                // Chart.jsãŒã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’å‰æ
                const chart = new Chart(ctx, chartConfig);

                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¾…ã¤ï¼ˆã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ç„¡åŠ¹åŒ–å¾Œã‚‚å¿µã®ãŸã‚å¾…æ©Ÿï¼‰
                await new Promise(resolve => setTimeout(resolve, 300));

                // html2canvasã§ã‚­ãƒ£ãƒ—ãƒãƒ£ï¼ˆè–„ã„ç°è‰²èƒŒæ™¯ï¼‰
                const capturedCanvas = await html2canvas(container, {
                    backgroundColor: '#f0f4f8',
                    scale: 2
                });

                chart.destroy();

                return capturedCanvas.toDataURL('image/png');
            }

            // ãƒ¬ãƒãƒ¼ãƒˆä½œæˆï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼‰
            async function createReport(userName, startDate, endDate, analysis, reportData, chartImages) {
                // ãƒ­ãƒ¼ã‚«ãƒ«ã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ä¿å­˜
                return saveReportLocally(userName, startDate, endDate, analysis, reportData, chartImages);
            }

            // ãƒ­ãƒ¼ã‚«ãƒ«ä¿å­˜ï¼ˆãƒ¬ãƒãƒ¼ãƒˆã‚’HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ä¿å­˜ï¼‰
            function saveReportLocally(userName, startDate, endDate, analysis, reportData, chartImages) {
                const reportHtml = `
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>ã€${startDate}ã€œ${endDate}ã€‘${userName}_ç¿’æ…£ãƒ¬ãƒãƒ¼ãƒˆ</title>
    <style>
        body { font-family: 'Inter', sans-serif; max-width: 800px; margin: 0 auto; padding: 24px; background: #f5f5f5; }
        .report-card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        h1 { color: #0891B2; }
        h2 { color: #333; border-bottom: 2px solid #0891B2; padding-bottom: 8px; }
        .chart-img { max-width: 100%; border-radius: 8px; margin: 16px 0; }
        .stat-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
        .stat-box { background: #f0f9ff; border-radius: 12px; padding: 16px; text-align: center; }
        .stat-value { font-size: 2rem; font-weight: 800; color: #0891B2; }
        .stat-label { font-size: 0.875rem; color: #666; }
        .advice-text { white-space: pre-wrap; }
    </style>
</head>
<body>
    <div class="report-card">
        <h1>ğŸ“Š ç¿’æ…£åŒ–ãƒ¬ãƒãƒ¼ãƒˆ</h1>
        <p>å¯¾è±¡æœŸé–“: ${startDate} ã€œ ${endDate}</p>
        <p>å¯¾è±¡è€…: ${userName}</p>
    </div>

    <div class="report-card">
        <h2>ğŸ“ ç·è«–</h2>
        <p>${analysis.summary}</p>
    </div>

    <div class="report-card">
        <div class="stat-grid">
            <div class="stat-box">
                <div class="stat-value">${reportData.uniqueDates.length}</div>
                <div class="stat-label">è¨˜éŒ²æ—¥æ•°</div>
            </div>
            <div class="stat-box">
                <div class="stat-value">${reportData.habits.length}</div>
                <div class="stat-label">ç¿’æ…£æ•°</div>
            </div>
            <div class="stat-box">
                <div class="stat-value">${reportData.logs.length}</div>
                <div class="stat-label">ç·è¨˜éŒ²æ•°</div>
            </div>
        </div>
    </div>

    <div class="report-card">
        <h2>ğŸ“ˆ æ›œæ—¥åˆ¥é”æˆç‡</h2>
        <img class="chart-img" src="${chartImages.weekday}" alt="æ›œæ—¥åˆ¥é”æˆç‡">
    </div>

    <div class="report-card">
        <h2>ğŸ“Š ç¿’æ…£åˆ¥é”æˆç‡</h2>
        <img class="chart-img" src="${chartImages.habit}" alt="ç¿’æ…£åˆ¥é”æˆç‡">
    </div>

    <div class="report-card">
        <h2>ğŸ’ª å¾—æ„ãªç‚¹</h2>
        <p>${analysis.strengths}</p>
    </div>

    <div class="report-card">
        <h2>ğŸ”§ æ”¹å–„ç‚¹</h2>
        <p>${analysis.improvements}</p>
    </div>

    <div class="report-card">
        <h2>ğŸ’¡ å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹</h2>
        <p class="advice-text">${analysis.advice}</p>
    </div>
</body>
</html>`;

                // HTMLãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([reportHtml], { type: 'text/html;charset=utf-8' });
                const downloadUrl = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = downloadUrl;
                link.download = `${userName}_ç¿’æ…£ãƒ¬ãƒãƒ¼ãƒˆ_${startDate}_${endDate}.html`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰URLï¼ˆæ–°ã—ã„ã‚¿ãƒ–ã§é–‹ãç”¨ï¼‰
                return { type: 'local', url: downloadUrl, fileName: link.download };
            }

            // Markdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
            // Markdownå½¢å¼ã®ãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ç”Ÿæˆ
            function generateReportMarkdown(userName, startDate, endDate, analysis, reportData) {
                const avgRate = reportData.habitStats.length > 0
                    ? Math.round(reportData.habitStats.reduce((sum, h) => sum + h.rate, 0) / reportData.habitStats.length * 10) / 10
                    : 0;

                // æœ€é«˜é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
                let maxStreak = 0;
                let currentStreak = 0;
                const sortedDates = [...reportData.uniqueDates].sort();
                for (let i = 0; i < sortedDates.length; i++) {
                    if (i === 0) {
                        currentStreak = 1;
                    } else {
                        const prevDate = new Date(sortedDates[i - 1]);
                        const currDate = new Date(sortedDates[i]);
                        const diffDays = (currDate - prevDate) / (24 * 60 * 60 * 1000);
                        if (diffDays === 1) {
                            currentStreak++;
                        } else {
                            currentStreak = 1;
                        }
                    }
                    maxStreak = Math.max(maxStreak, currentStreak);
                }

                // æœˆåˆ¥ã®ãƒ¬ãƒãƒ¼ãƒˆã‚¿ã‚¤ãƒˆãƒ«
                let reportTitle;
                let periodDescription;

                if (currentReportMonth >= 1 && currentReportMonth <= 9) {
                    const startDay = (currentReportMonth - 1) * 30 + 1;
                    const endDay = currentReportMonth * 30;
                    reportTitle = `${userName}ã•ã‚“_${currentReportMonth}ãƒ¶æœˆç¿’æ…£è¨˜éŒ²`;
                    periodDescription = `${startDay}æ—¥ç›®ã€œ${endDay}æ—¥ç›®ã®å®Ÿç¸¾ï¼ˆ30æ—¥é–“ï¼‰`;
                } else {
                    reportTitle = `${userName}ã•ã‚“_ç¿’æ…£è¨˜éŒ²`;
                    periodDescription = `ç¿’æ…£åŒ–ã®å®Ÿç¸¾`;
                }

                return `# ${reportTitle}

${periodDescription}

**å¯¾è±¡æœŸé–“**: ${startDate} ã€œ ${endDate}

ã¾ãšã¯ã©ã‚Œã ã‘ã‚ãªãŸãŒç¿’æ…£ã‚’ç©ã¿ä¸Šã’ãŸã‹ã‚’ç¢ºèªã—ã¾ã—ã‚‡ã†

---


## ğŸ“ˆ ã‚µãƒãƒªãƒ¼

${analysis.summary}

---

## | æ›œæ—¥åˆ¥é”æˆç‡

ã€ã“ã“ã«æ›œæ—¥åˆ¥é”æˆç‡ã‚°ãƒ©ãƒ•ã‚’æŒ¿å…¥ã€‘

---

## | ç¿’æ…£åˆ¥é”æˆç‡

ã€ã“ã“ã«ç¿’æ…£åˆ¥é”æˆç‡ã‚°ãƒ©ãƒ•ã‚’æŒ¿å…¥ã€‘

---

---

## âš ï¸ 2æ—¥é€£ç¶šç¿’æ…£å¤±æ•—å›æ•°

${Object.entries(reportData.consecutiveFailures).map(([name, count]) => `- **${name}**: ${count}å›`).join('\n')}

---

## ğŸ¯ ã‚ãªãŸã®ç¿’æ…£ç·è©•

### ğŸ’ª å¾—æ„ãªç‚¹

${analysis.strengths}

### â—‡ è‹¦æ‰‹ãªç‚¹

${analysis.improvements}

---

## ğŸ’¡ å…·ä½“çš„ã‚¢ãƒ‰ãƒã‚¤ã‚¹

${analysis.advice}
`;
            }

            // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°ã§ãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ä¿æŒ
            let currentReportText = '';

            // ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
            function showReportModal(reportText) {
                currentReportText = reportText;
                document.getElementById('reportTextContent').textContent = reportText;
                document.getElementById('reportTextModal').classList.add('show');
            }

            // ãƒ¬ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
            window.closeReportModal = () => {
                document.getElementById('reportTextModal').classList.remove('show');
            };

            // ãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼
            window.copyReportText = async () => {
                try {
                    await navigator.clipboard.writeText(currentReportText);
                    showToast('ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
                } catch (e) {
                    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                    const textarea = document.createElement('textarea');
                    textarea.value = currentReportText;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast('ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
                }
            };

            // ã‚°ãƒ©ãƒ•ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            window.downloadChartImage = (type) => {
                if (!window.currentChartImages) {
                    showToast('ã‚°ãƒ©ãƒ•ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                    return;
                }

                const imageData = window.currentChartImages[type];
                if (!imageData) {
                    showToast('æŒ‡å®šã•ã‚ŒãŸã‚°ãƒ©ãƒ•ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }

                // Base64ç”»åƒãƒ‡ãƒ¼ã‚¿ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const link = document.createElement('a');
                link.href = imageData;

                const fileName = type === 'weekday'
                    ? 'æ›œæ—¥åˆ¥é”æˆç‡ã‚°ãƒ©ãƒ•.png'
                    : 'ç¿’æ…£åˆ¥é”æˆç‡ã‚°ãƒ©ãƒ•.png';

                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showToast(`ğŸ“¥ ${fileName} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
            };

            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’ç”Ÿæˆ
            async function generateSummaryCardImage(reportData) {
                try {
                    const { uniqueDates, habitStats, logs } = reportData;

                    // ç·å®Ÿè¡Œæ—¥æ•°
                    const totalDays = uniqueDates.length;

                    // å¹³å‡é”æˆç‡
                    const avgRate = habitStats.length > 0
                        ? Math.round(habitStats.reduce((sum, h) => sum + h.rate, 0) / habitStats.length)
                        : 0;

                    // æœ€é«˜é€£ç¶šæ—¥æ•°ã‚’è¨ˆç®—
                    const sortedDates = [...uniqueDates].sort();
                    let maxStreak = 0;
                    let currentStreak = 1;

                    if (sortedDates.length > 0) {
                        for (let i = 1; i < sortedDates.length; i++) {
                            const prevDate = new Date(sortedDates[i - 1]);
                            const currDate = new Date(sortedDates[i]);
                            const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));

                            if (diffDays === 1) {
                                currentStreak++;
                            } else {
                                maxStreak = Math.max(maxStreak, currentStreak);
                                currentStreak = 1;
                            }
                        }
                        maxStreak = Math.max(maxStreak, currentStreak);
                    }

                    // ã‚«ãƒ¼ãƒ‰ã®HTMLç”Ÿæˆ
                    const cardContainer = document.createElement('div');
                    cardContainer.id = 'summaryCardContainer';
                    cardContainer.style.cssText = `
                        position: fixed;
                        left: -9999px;
                        top: 0;
                        width: 750px;
                        padding: 20px;
                        background: linear-gradient(135deg, #f0f4f8 0%, #e8ecf1 100%);
                        border-radius: 16px;
                        display: flex;
                        gap: 12px;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    `;

                    cardContainer.innerHTML = `
                        <div style="flex:1; background:white; border-radius:12px; padding:20px; text-align:center; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <div style="font-size:28px; margin-bottom:6px;">ğŸ“…</div>
                            <div style="font-size:42px; font-weight:700; color:#3b82f6; margin-bottom:6px;">${totalDays}æ—¥</div>
                            <div style="font-size:14px; color:#6b7280; font-weight:500;">ç·å®Ÿè¡Œæ—¥æ•°</div>
                        </div>
                        <div style="flex:1; background:white; border-radius:12px; padding:20px; text-align:center; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <div style="font-size:28px; margin-bottom:6px;">ğŸ”¥</div>
                            <div style="font-size:42px; font-weight:700; color:#3b82f6; margin-bottom:6px;">${maxStreak}æ—¥</div>
                            <div style="font-size:14px; color:#6b7280; font-weight:500;">æœ€é«˜é€£ç¶šæ—¥æ•°</div>
                        </div>
                        <div style="flex:1; background:white; border-radius:12px; padding:20px; text-align:center; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                            <div style="font-size:28px; margin-bottom:6px;">ğŸ“Š</div>
                            <div style="font-size:42px; font-weight:700; color:#3b82f6; margin-bottom:6px;">${avgRate}%</div>
                            <div style="font-size:14px; color:#6b7280; font-weight:500;">ç¿’æ…£å®Ÿè¡Œç‡</div>
                        </div>
                    `;

                    document.body.appendChild(cardContainer);

                    // DOMã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’å¾…ã¤
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const canvas = await html2canvas(cardContainer, {
                        backgroundColor: '#f0f4f8',
                        scale: 2,
                        logging: false,
                        useCORS: true
                    });
                    const imageData = canvas.toDataURL('image/png');

                    // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã«ä¿å­˜
                    if (!window.currentChartImages) {
                        window.currentChartImages = {};
                    }
                    window.currentChartImages.summary = imageData;

                    document.body.removeChild(cardContainer);
                    console.log('ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ç”Ÿæˆå®Œäº†');
                    return imageData;
                } catch (error) {
                    console.error('ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    showToast('ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    return null;
                }
            }

            // ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            window.downloadSummaryCard = () => {
                console.log('downloadSummaryCard called');
                console.log('currentChartImages:', window.currentChartImages);

                if (!window.currentChartImages?.summary) {
                    console.log('summary not found');
                    showToast('ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                    return;
                }

                console.log('summary found, starting download');

                try {
                    const link = document.createElement('a');
                    link.href = window.currentChartImages.summary;
                    link.download = 'ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰.png';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    showToast('ğŸ“¥ ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰.png ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
                    console.log('download completed');
                } catch (e) {
                    console.error('download error:', e);
                    showToast('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            };

            // ç¿’æ…£åˆ¥Ã—æ›œæ—¥åˆ¥æˆåŠŸç‡ã®è¡¨ã‚’ç”Ÿæˆ
            async function generateHabitWeekdayTableImage(reportData) {
                try {
                    const { habitStats, habitDayOfWeekStats } = reportData;
                    const days = ['æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ', 'æ—¥'];
                    const dayIndexMap = { 'æœˆ': 0, 'ç«': 1, 'æ°´': 2, 'æœ¨': 3, 'é‡‘': 4, 'åœŸ': 5, 'æ—¥': 6 };

                    // ãƒ¬ãƒãƒ¼ãƒˆæœŸé–“ä¸­ã«è¨˜éŒ²ãŒã‚ã‚‹ç¿’æ…£
                    const activeHabitNames = habitStats.map(h => h.name);

                    // ç¿’æ…£ã”ã¨Ã—æ›œæ—¥ã”ã¨ã®æˆåŠŸç‡ã¯æ—¢ã«è¨ˆç®—æ¸ˆã¿ã®habitDayOfWeekStatsã‚’ä½¿ç”¨
                    const tableData = activeHabitNames.map(habitName => {
                        const habitData = habitDayOfWeekStats[habitName];
                        if (!habitData) {
                            return {
                                name: habitName,
                                rates: days.map(() => '-')
                            };
                        }

                        // æœˆæ›œå§‹ã¾ã‚Šã«ä¸¦ã¹æ›¿ãˆ
                        return {
                            name: habitName,
                            rates: days.map(dayName => {
                                const dayData = habitData.find(d => d.day === dayName);
                                return dayData && dayData.rate !== undefined ? dayData.rate : '-';
                            })
                        };
                    });

                    // è¡¨ã®HTMLç”Ÿæˆ
                    const tableContainer = document.createElement('div');
                    tableContainer.style.cssText = `
                        position: fixed;
                        left: -9999px;
                        top: 0;
                        padding: 20px;
                        background: #f0f4f8;
                        border-radius: 16px;
                        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                    `;

                    const headerCells = days.map(d => `<th style="padding:10px 16px; background:#3b82f6; color:white; font-weight:600;">${d}</th>`).join('');
                    const bodyRows = tableData.map(row => `
                        <tr>
                            <td style="padding:10px 16px; background:#e8ecf1; font-weight:600; white-space:nowrap;">${row.name}</td>
                            ${row.rates.map(r => `<td style="padding:10px 16px; text-align:center; background:white;">${r === '-' ? '-' : r + '%'}</td>`).join('')}
                        </tr>
                    `).join('');

                    tableContainer.innerHTML = `
                        <div style="font-size:16px; font-weight:700; margin-bottom:12px; color:#1F2937; text-align:center;">ç¿’æ…£åˆ¥ã®æ›œæ—¥åˆ¥æˆåŠŸç‡ï¼ˆ%ï¼‰</div>
                        <table style="border-collapse:collapse; border-radius:8px; overflow:hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08);">
                            <thead>
                                <tr>
                                    <th style="padding:10px 16px; background:#1F2937; color:white; font-weight:600;">ç¿’æ…£</th>
                                    ${headerCells}
                                </tr>
                            </thead>
                            <tbody>
                                ${bodyRows}
                            </tbody>
                        </table>
                    `;

                    document.body.appendChild(tableContainer);
                    await new Promise(resolve => setTimeout(resolve, 100));

                    const canvas = await html2canvas(tableContainer, {
                        backgroundColor: '#f0f4f8',
                        scale: 2,
                        logging: false
                    });
                    const imageData = canvas.toDataURL('image/png');

                    if (!window.currentChartImages) {
                        window.currentChartImages = {};
                    }
                    window.currentChartImages.weekdayTable = imageData;

                    document.body.removeChild(tableContainer);
                    console.log('æ›œæ—¥åˆ¥è¡¨ç”Ÿæˆå®Œäº†');
                    return imageData;
                } catch (error) {
                    console.error('æ›œæ—¥åˆ¥è¡¨ç”Ÿæˆã‚¨ãƒ©ãƒ¼:', error);
                    return null;
                }
            }

            // æ›œæ—¥åˆ¥è¡¨ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            window.downloadWeekdayTable = () => {
                if (!window.currentChartImages?.weekdayTable) {
                    showToast('æ›œæ—¥åˆ¥è¡¨ãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                    return;
                }

                const link = document.createElement('a');
                link.href = window.currentChartImages.weekdayTable;
                link.download = 'æ›œæ—¥åˆ¥æˆåŠŸç‡è¡¨.png';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                showToast('ğŸ“¥ æ›œæ—¥åˆ¥æˆåŠŸç‡è¡¨.png ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ');
            };

            // å…¨ç”»åƒã‚’ä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            window.downloadAllImages = async () => {
                const images = window.currentChartImages || {};

                if (Object.keys(images).length === 0) {
                    showToast('ç”»åƒãŒã‚ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ãƒ¬ãƒãƒ¼ãƒˆã‚’ç”Ÿæˆã—ã¦ãã ã•ã„');
                    return;
                }

                showToast('ğŸ“¦ ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...');

                const downloads = [
                    { key: 'summary', name: '1_ã‚µãƒãƒªãƒ¼ã‚«ãƒ¼ãƒ‰.png' },
                    { key: 'weekday', name: '2_æ›œæ—¥åˆ¥é”æˆç‡ã‚°ãƒ©ãƒ•.png' },
                    { key: 'habit', name: '3_ç¿’æ…£åˆ¥é”æˆç‡ã‚°ãƒ©ãƒ•.png' },
                    { key: 'weekdayTable', name: '4_æ›œæ—¥åˆ¥æˆåŠŸç‡è¡¨.png' }
                ];

                let count = 0;
                for (const { key, name } of downloads) {
                    if (images[key]) {
                        const link = document.createElement('a');
                        link.href = images[key];
                        link.download = name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        count++;
                        // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰é–“ã«å°‘ã—å¾…æ©Ÿ
                        await new Promise(resolve => setTimeout(resolve, 300));
                    }
                }

                showToast(`ğŸ“¦ ${count} æšã®ç”»åƒã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸï¼`);
            };

            // åˆæœŸåŒ–æ™‚ã«APIè¨­å®šã‚’èª­ã¿è¾¼ã¿ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            document.addEventListener('DOMContentLoaded', () => {
                setTimeout(() => {
                    loadApiSettings();
                    updateReportUserSelect();
                }, 500);
            });

            // renderUsersã®å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒªã‚¹ãƒˆã‚’æ›´æ–°
            const originalRenderUsers = renderUsers;
            window.renderUsers = function () {
                originalRenderUsers();
                updateReportUserSelect();
            };
        </script>

        <!-- QRãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="qrModal">
            <div class="modal">
                <h3 id="qrTitle">QRã‚³ãƒ¼ãƒ‰</h3>
                <img id="qrImage" src="" alt="QR Code">
                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:20px;">ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦é–‹ã‘ã¾ã™</p>
                <div style="text-align:right;">
                    <button class="action-btn"
                        onclick="document.getElementById('qrModal').classList.remove('show')">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- ãƒªãƒ³ã‚¯ã‚³ãƒ”ãƒ¼ç”¨ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="linkModal">
            <div class="modal">
                <h3 id="linkTitle">ğŸ”— å…±æœ‰ãƒªãƒ³ã‚¯</h3>
                <p style="font-size:0.8rem; color:var(--text-muted); margin-bottom:12px;">ä¸‹ã®ãƒªãƒ³ã‚¯ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦å…±æœ‰ã—ã¦ãã ã•ã„
                </p>
                <div style="display:flex; gap:8px; margin-bottom:20px;">
                    <input type="text" id="linkUrlDisplay" class="modal-input" style="flex:1;" readonly>
                    <button class="btn-3d btn-primary" onclick="copyLinkUrl()"
                        style="font-size:0.9rem; padding:10px 16px;">ã‚³ãƒ”ãƒ¼</button>
                </div>
                <div style="text-align:right;">
                    <button class="action-btn" onclick="closeLinkModal()">é–‰ã˜ã‚‹</button>
                </div>
            </div>
        </div>

        <!-- é éš”ç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="modal-overlay" id="remoteEditModal">
            <div class="modal">
                <h3>ğŸ‘¤ åˆ©ç”¨è€…ã®é éš”ç·¨é›†</h3>

                <div style="margin-bottom:16px;">
                    <label style="font-size:0.8rem; font-weight:700; display:block; margin-bottom:4px;">åˆ©ç”¨è€…å</label>
                    <input type="text" id="editUserName" class="modal-input" style="width:100%;">
                </div>

                <div style="margin-bottom:16px;">
                    <label
                        style="font-size:0.8rem; font-weight:700; display:block; margin-bottom:4px;">ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆé–‹å§‹æ—¥</label>
                    <input type="date" id="editUserStart" class="modal-input" style="width:100%;">
                </div>

                <label style="font-size:0.8rem; font-weight:700; display:block; margin-bottom:8px;">ç¿’æ…£åã®ç·¨é›†</label>
                <div id="remoteHabitList" style="max-height:300px; overflow-y:auto; margin-bottom:20px;"></div>

                <div style="border-top:2px solid var(--border); margin:20px 0; padding-top:20px;">
                    <label style="font-size:0.8rem; font-weight:700; display:block; margin-bottom:8px;">â•
                        æ–°è¦ç¿’æ…£ã‚’è¿½åŠ </label>
                    <div style="display:flex; gap:8px;">
                        <input type="text" id="newHabitName" placeholder="ç¿’æ…£å..." class="modal-input" style="flex:1;">
                        <select id="newHabitType" class="modal-select" style="width:100px;">
                            <option value="check">ãƒã‚§ãƒƒã‚¯</option>
                            <option value="count">ã‚«ã‚¦ãƒ³ãƒˆ</option>
                        </select>
                        <button class="btn-3d btn-primary" onclick="addRemoteHabit()"
                            style="font-size:0.9rem; padding:10px 16px;">è¿½åŠ </button>
                    </div>
                </div>
                <div class="modal-buttons">
                    <button class="modal-btn cancel" id="remoteEditCancel">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button class="modal-btn confirm" id="remoteEditConfirm">ä¿å­˜</button>
                </div>
            </div>
        </div>

        <!-- ãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆãƒ¢ãƒ¼ãƒ€ãƒ« -->
        <div class="report-modal-overlay" id="reportTextModal">
            <div class="report-modal">
                <div class="report-modal-header">
                    <h3>ğŸ“‹ ãƒ¬ãƒãƒ¼ãƒˆãƒ†ã‚­ã‚¹ãƒˆï¼ˆã‚³ãƒ”ãƒ¼ç”¨ï¼‰</h3>
                    <button onclick="closeReportModal()"
                        style="background:none; border:none; font-size:1.5rem; cursor:pointer;">âœ•</button>
                </div>
                <div class="report-modal-body">
                    <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:12px;">
                        ä¸‹ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€Notionã‚„ãƒ¡ãƒ¢ã‚¢ãƒ—ãƒªã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ã€‚<br>
                        Markdown å½¢å¼ã§è¨˜è¿°ã•ã‚Œã¦ã„ã¾ã™ã€‚<br>
                        <strong>ç”»åƒã¯ã€ŒğŸ“¦ å…¨ç”»åƒä¸€æ‹¬ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã€ã§ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚</strong>
                    </p>
                    <div class="report-text-content" id="reportTextContent" style="max-height:60vh; overflow-y:auto;">
                    </div>
                </div>
                <div class="report-modal-footer">
                    <button class="btn-3d" onclick="closeReportModal()">é–‰ã˜ã‚‹</button>
                    <button class="btn-3d btn-primary" onclick="copyReportText()">ğŸ“‹ ãƒ†ã‚­ã‚¹ãƒˆã‚’ã‚³ãƒ”ãƒ¼</button>
                </div>
            </div>
        </div>
</body>

</html>